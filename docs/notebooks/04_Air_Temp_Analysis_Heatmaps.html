

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2D Air Temperature Analysis: Heatmaps &mdash; CoKLIMAx 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=822aaed9" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=8d563738"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script type="application/vnd.jupyter.widget-state+json">{"state": {"a86497ec81c746f9b90fb36631f52398": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "5d69da2325734c109e715cccb9eaca8b": {"model_name": "DescriptionStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "description_width": ""}}, "0cef094b19c94ade9f46e666ad22a613": {"model_name": "DropdownModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "DropdownModel", "_options_labels": ["ta_2m*_xy"], "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "DropdownView", "description": "Select test variable:", "description_allow_html": false, "disabled": false, "index": 0, "layout": "IPY_MODEL_a86497ec81c746f9b90fb36631f52398", "style": "IPY_MODEL_5d69da2325734c109e715cccb9eaca8b", "tabbable": null, "tooltip": null}}}, "version_major": 2, "version_minor": 0}</script>
      <script crossorigin="anonymous" data-jupyter-widgets-cdn="https://cdn.jsdelivr.net/npm/" src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.6/dist/embed-amd.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2D Air Temperature Aggregation Tool" href="05_Air_Temp_with_Agg.html" />
    <link rel="prev" title="2D Air Temperature Analysis: Baseline vs. Scenario" href="03_Air_Temp_Analysis_BS_vs_S1.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            CoKLIMAx
              <img src="../_static/coklimax_logo_new.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Data Preparation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="_01_2D_Var_Agg_and_Extract.html">2D Variable Aggregation and Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="_02_3D_to_2d_Surface_Var_Extract.html">3D Variable Surface Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="_03_2D_Surface_Var_Agg_and_Extract.html">3D Variable Extraction and Aggregation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Preminimary:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="01_Obs_vs_Sim.html">Comparison of Observed vs Simulation Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_Distance_of_AOI_vs_t-test.html">Distance of AOI vs t-test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Variable: Temperature:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="03_Air_Temp_Analysis_BS_vs_S1.html">2D Air Temperature Analysis: Baseline vs. Scenario</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2D Air Temperature Analysis: Heatmaps</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#import-dependencies">1. Import Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="#import-data">2. Import Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#variable-selection">3. Variable Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#define-time-sequences-and-equivalents">4. Define Time Sequences and Equivalents</a></li>
<li class="toctree-l2"><a class="reference internal" href="#helper-functions-for-spatial-operations-and-plotting">5. Helper Functions for Spatial Operations and Plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#extract-variable-data-and-define-areas-of-interest-aois">6. Extract Variable Data and Define Areas of Interest (AOIs)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#define-time-periods-for-analysis">7. Define Time Periods for Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#compute-mean-temperature-maps">8. Compute Mean Temperature Maps</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visualize-mean-temperature-heatmaps">9. Visualize Mean Temperature Heatmaps</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visualize-mean-temperature-heatmaps-night-1">10. Visualize Mean Temperature Heatmaps (Night 1)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visualize-mean-temperature-difference-heatmaps-day-1-and-day-2">11. Visualize Mean Temperature Difference Heatmaps (Day 1 and Day 2)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#perform-t-test-at-individual-pixels">12. Perform T-test at Individual Pixels</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visualize-t-test-results-heatmaps-day-1-and-day-2">13. Visualize T-test Results Heatmaps (Day 1 and Day 2)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visualize-t-test-results-heatmaps-night-1">14. Visualize T-test Results Heatmaps (Night 1)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="05_Air_Temp_with_Agg.html">2D Air Temperature Aggregation Tool</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Variables: Biometeorology:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="06_Bio_Var_Analysis_BS_vs_S1.html">2D Biometeorological Variable Analysis: Baseline vs. Scenario</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_Bio_Var_Analysis_BS_vs_S1.html">Biological Variable Analysis</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CoKLIMAx</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">2D Air Temperature Analysis: Heatmaps</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/04_Air_Temp_Analysis_Heatmaps.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="d-air-temperature-analysis-heatmaps">
<h1>2D Air Temperature Analysis: Heatmaps<a class="headerlink" href="#d-air-temperature-analysis-heatmaps" title="Link to this heading"></a></h1>
<p>This notebook provides a comprehensive analysis of 2-meter air temperature (ta_2m) from PALM (Potsdam Atmospheric Large-Eddy Simulation Model) 2D output files. It focuses on visualizing spatial temperature distributions and statistical differences between a Baseline simulation scenario and Scenario 1.</p>
<ul class="simple">
<li><p><strong>Data Loading and Preprocessing</strong>: Imports 2D av_xy_N03.000.nc files and static driver data.</p></li>
<li><p><strong>Variable Selection</strong>: Allows interactive selection of the 2D variable for analysis.</p></li>
<li><p><strong>Time Series Definition</strong>: Defines time sequences and equivalents for temporal aggregation.</p></li>
<li><p><strong>Spatial Analysis</strong>: Computes and visualizes mean temperature heatmaps for different periods (day/night) and calculates mean differences between scenarios.</p></li>
<li><p><strong>Statistical Testing</strong>: Performs independent t-tests at individual pixel levels to identify statistically significant temperature differences.</p></li>
<li><p><strong>Visualization</strong>: Generates heatmaps to display mean temperatures, mean differences, and t-test results, enhanced with AOI (Area of Interest) overlays and statistical summary tables.</p></li>
</ul>
<p>The goal is to provide a detailed spatial and temporal understanding of the impact of Scenario 1 on air temperature, highlighting areas with significant changes.</p>
<section id="import-dependencies">
<h2>1. Import Dependencies<a class="headerlink" href="#import-dependencies" title="Link to this heading"></a></h2>
<p>This section imports all necessary libraries for data manipulation, NetCDF file handling, geographical data processing, statistical analysis, interactive widgets, and advanced plotting capabilities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">netCDF4</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy.ma</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ma</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ipywidgets</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">widgets</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ticker</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">patches</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">FixedLocator</span><span class="p">,</span> <span class="n">MultipleLocator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patheffects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pe</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearSegmentedColormap</span> <span class="k">as</span> <span class="n">lsc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Patch</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">palm_variables</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="import-data">
<h2>2. Import Data<a class="headerlink" href="#import-data" title="Link to this heading"></a></h2>
<p>This section defines the file paths for the 2D simulation output NetCDF files (for baseline and scenario 1) and the static driver file. These files are then loaded into netCDF4.Dataset objects, making their contents accessible for processing. The buildings_2d data from the static driver is also extracted, which is used for masking non-atmospheric grid cells during data extraction.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Absolute URLs (paths) of 2D xy-averaged simulation output files and the static driver file.</span>
<span class="n">file_xy_1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;./Data/agg_6/konstanz_4096x4096_v9_Baseline_av_xy_N03_ta_2m_xy.nc&quot;</span>
<span class="n">file_xy_2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;./Data/agg_6/konstanz_4096x4096_v9_Scenario_1_av_xy_N03_ta_2m_xy.nc&quot;</span>
<span class="n">file_xy_ref</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;./Data/_simulation_outputs_3/konstanz_4096x4096_v9_Baseline-48hr/OUTPUT/konstanz_4096x4096_v9_Baseline_av_xy_N03.000.nc&quot;</span>
<span class="n">file_static</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;./Data/INPUT/konstanz_4096x4096_v9_Baseline_static_N03&quot;</span>

<span class="c1"># Read NetCDF files into Dataset objects in read mode (&#39;r&#39;).</span>
<span class="n">dataset_1</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">file_xy_1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">dataset_2</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">file_xy_2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">dataset_ref</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">file_xy_ref</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">dataset_3</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">file_static</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

<span class="c1"># Store the Dataset objects and their corresponding file paths in lists for easy iteration.</span>
<span class="n">file_xy_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_xy_1</span><span class="p">,</span> <span class="n">file_xy_2</span><span class="p">]</span>
<span class="n">dataset_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset_1</span><span class="p">,</span> <span class="n">dataset_2</span><span class="p">]</span>

<span class="c1"># Extract 2D buildings data from the static dataset.</span>
<span class="c1"># This data is crucial for masking out non-atmospheric grid cells (e.g., inside buildings)</span>
<span class="c1"># when performing spatial averages or statistical tests.</span>
<span class="n">buildings_2d</span> <span class="o">=</span> <span class="n">dataset_3</span><span class="p">[</span><span class="s1">&#39;buildings_2d&#39;</span><span class="p">]</span>
<span class="n">buildings_2d_data</span> <span class="o">=</span> <span class="n">buildings_2d</span><span class="p">[:,</span> <span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="variable-selection">
<h2>3. Variable Selection<a class="headerlink" href="#variable-selection" title="Link to this heading"></a></h2>
<p>This section allows the user to interactively select a 2D variable from the loaded NetCDF datasets. A dropdown widget is provided for selection, and the chosen variable’s description and unit (retrieved from the palm_variables module) are displayed for clear identification.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract variable names from the first dataset where the number of dimensions is greater than 2.</span>
<span class="c1"># In PALM xy-averaged output files, these typically represent 2D spatial data over time (time, y, x).</span>
<span class="n">var_names_palm</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">dataset_1</span><span class="o">.</span><span class="n">variables</span> <span class="k">if</span> <span class="n">dataset_1</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">]</span>

<span class="c1"># Initialize `test_variable` with the first variable in the list (`var_names_palm[0]`),</span>
<span class="c1"># which is commonly &#39;ta_2m*_xy&#39; for 2-m air temperature.</span>
<span class="n">test_variable</span> <span class="o">=</span> <span class="n">var_names_palm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Create a dropdown widget to allow the user to select the desired 2D variable.</span>
<span class="n">drop_down</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
    <span class="n">options</span><span class="o">=</span><span class="n">var_names_palm</span><span class="p">,</span>         <span class="c1"># Populate the dropdown with the extracted 2D variable names.</span>
    <span class="n">value</span><span class="o">=</span><span class="n">var_names_palm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>        <span class="c1"># Set the initial selected value in the dropdown.</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Select test variable:&#39;</span> <span class="c1"># Label displayed next to the dropdown.</span>
<span class="p">)</span>

<span class="c1"># Define a handler function that will be called whenever the dropdown&#39;s value changes.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dropdown_handler</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">test_variable</span>  <span class="c1"># Declare `test_variable` as global to modify it.</span>
    <span class="n">test_variable</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">new</span>     <span class="c1"># Update the global `test_variable` with the newly selected value.</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected variable: </span><span class="si">{</span><span class="n">test_variable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Print the newly selected variable to the console.</span>

<span class="c1"># Attach the `dropdown_handler` function to observe changes in the &#39;value&#39; property of the dropdown.</span>
<span class="n">drop_down</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">dropdown_handler</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>

<span class="c1"># Display the dropdown widget in the notebook output.</span>
<span class="n">display</span><span class="p">(</span><span class="n">drop_down</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "0cef094b19c94ade9f46e666ad22a613"}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check if the selected `test_variable` string contains a wildcard character &#39;*&#39;.</span>
<span class="c1"># This is common for PALM variables indicating an xy-averaged or general 2D field.</span>
<span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">test_variable</span><span class="p">:</span>
    <span class="c1"># If a wildcard is present, extract the base part of the variable name (e.g., &#39;ta_2m&#39; from &#39;ta_2m*_xy&#39;)</span>
    <span class="c1"># and re-append &#39;*&#39; to match the keys in `palm_variables.variables_dict`.</span>
    <span class="n">var_initial</span> <span class="o">=</span> <span class="n">test_variable</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span>
    <span class="c1"># Retrieve the dictionary of information for `var_initial` from the `palm_variables` module.</span>
    <span class="n">variable_info</span> <span class="o">=</span> <span class="n">palm_variables</span><span class="o">.</span><span class="n">variables_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var_initial</span><span class="p">,</span> <span class="p">{})</span>
    <span class="c1"># Extract the &#39;unit&#39; from `variable_info`, defaulting to &#39;No unit available&#39; if the key is missing.</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">variable_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;No unit available&#39;</span><span class="p">)</span>
    <span class="c1"># Extract the &#39;description&#39; from `variable_info`, defaulting to &#39;No description available&#39; if the key is missing.</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">variable_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;No description available&#39;</span><span class="p">)</span>
    <span class="c1"># Print the capitalized description and its unit.</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">description</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2-m air temperature, °C
</pre></div>
</div>
</div>
</div>
</section>
<section id="define-time-sequences-and-equivalents">
<h2>4. Define Time Sequences and Equivalents<a class="headerlink" href="#define-time-sequences-and-equivalents" title="Link to this heading"></a></h2>
<p>This section dynamically extracts the total number of time steps from the loaded dataset. It then defines parameters for time step intervals and calculates sequences and human-readable time equivalents (HH:MM format) for both hourly and all time steps. These sequences are crucial for temporal aggregation and plotting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract `variable_data_1` for the `test_variable` from the first dataset.</span>
<span class="n">variable_data_1</span> <span class="o">=</span> <span class="n">dataset_1</span><span class="p">[</span><span class="n">test_variable</span><span class="p">]</span>

<span class="c1"># Get the shape of `variable_data_1` to determine the total number of time steps.</span>
<span class="n">variable_data_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">variable_data_1</span><span class="p">)</span>
<span class="n">total_time_steps</span> <span class="o">=</span> <span class="n">variable_data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># The first dimension is usually time.</span>

<span class="c1"># Define `time_step_interval`: This controls how frequently data points are sampled or aggregated.</span>
<span class="c1"># In PALM, each time step typically represents 10 minutes. Here it is set to 6, for hourly data (6 * 10 minutes = 60 minutes).</span>
<span class="n">time_step_interval</span> <span class="o">=</span> <span class="mi">6</span>

<span class="c1"># Define `second_step`: This offset helps align `time_sequence_hourly` with actual hour marks.</span>
<span class="c1"># If time steps are 0-indexed and represent 10-minute intervals:</span>
<span class="c1">#   - `second_step = 0`: Corresponds to 0:00, 0:10, 0:20...</span>
<span class="c1">#   - `second_step = 5`: Corresponds to 0:50, 1:50, 2:50... (often used for hourly averages centered at the hour)</span>
<span class="n">second_step</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># `time_sequence`: A list of time step indices for hourly intervals.</span>
<span class="c1"># It starts at `0` and extends by `time_step_interval` from `second_step`.</span>
<span class="n">time_sequence</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">time_sequence</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">second_step</span><span class="p">,</span> <span class="n">total_time_steps</span><span class="p">,</span> <span class="n">time_step_interval</span><span class="p">))</span>

<span class="c1"># `time_sequence_all`: A list containing all available time step indices (from 0 to `total_time_steps - 1`).</span>
<span class="n">time_sequence_all</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_time_steps</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_time_equivalent</span><span class="p">(</span><span class="n">time_sequence</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a sequence of time steps (each representing 10 minutes) into</span>
<span class="sd">    human-readable HH:MM format.</span>

<span class="sd">    Args:</span>
<span class="sd">        time_sequence (list or array): A list of time step indices.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing:</span>
<span class="sd">            - time_equivalent (list): List of time strings in HH:MM format (can exceed 24 hours).</span>
<span class="sd">            - time_equivalent_24hr (list): List of time strings in 24-hour HH:MM format (resets after 23:50).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time_equivalent</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">time_equivalent_24hr</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">time_step</span> <span class="ow">in</span> <span class="n">time_sequence</span><span class="p">:</span>
        <span class="c1"># Calculate total minutes from the start of the simulation (each step is 10 minutes).</span>
        <span class="n">total_minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> 
        <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">total_minutes</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span> <span class="c1"># Convert total minutes to hours and remaining minutes.</span>
        
        <span class="c1"># Append time equivalent in HH:MM format (hours can exceed 24, e.g., 25:00 for the next day).</span>
        <span class="n">time_equivalent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hours</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">minutes</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Calculate hours in a 24-hour cycle for `time_equivalent_24hr`.</span>
        <span class="n">hours_24hr</span> <span class="o">=</span> <span class="n">hours</span> <span class="o">%</span> <span class="mi">24</span> 
        <span class="n">time_equivalent_24hr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hours_24hr</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">minutes</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">time_equivalent</span><span class="p">,</span> <span class="n">time_equivalent_24hr</span>

<span class="c1"># Generate time equivalents for hourly and all time steps.</span>
<span class="n">time_equivalent</span><span class="p">,</span> <span class="n">time_equivalent_24hr</span> <span class="o">=</span> <span class="n">get_time_equivalent</span><span class="p">(</span><span class="n">time_sequence</span><span class="p">)</span>
<span class="n">time_equivalent_all</span><span class="p">,</span> <span class="n">time_equivalent_all_24hr</span> <span class="o">=</span> <span class="n">get_time_equivalent</span><span class="p">(</span><span class="n">time_sequence_all</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="helper-functions-for-spatial-operations-and-plotting">
<h2>5. Helper Functions for Spatial Operations and Plotting<a class="headerlink" href="#helper-functions-for-spatial-operations-and-plotting" title="Link to this heading"></a></h2>
<p>This section defines several helper functions crucial for spatial data manipulation and plot customization. These include functions for calculating grid coordinates, adjusting plot ticks, determining the date based on time index, and adding north arrows and scale bars to plots.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define grid spacing (dx, dy) from the reference dataset.</span>
<span class="c1"># Assuming dx and dy are constant and can be derived from the first two x/y coordinates.</span>
<span class="n">dx</span> <span class="o">=</span> <span class="n">dataset_ref</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dataset_ref</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">dy</span> <span class="o">=</span> <span class="n">dataset_ref</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dataset_ref</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Define number of cells in x and y dimensions.</span>
<span class="c1"># These are derived from the length of the &#39;x&#39; and &#39;y&#39; dimensions in the dataset.</span>
<span class="n">nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dataset_ref</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dataset_ref</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Coordinates of the origin in PALM (origin_x, origin_y, origin_z).</span>
<span class="c1"># These represent the real-world (e.g., UTM) coordinates of the southwest corner of the simulation domain.</span>
<span class="n">origin_x</span><span class="p">,</span> <span class="n">origin_y</span><span class="p">,</span> <span class="n">origin_z</span> <span class="o">=</span> <span class="n">dataset_ref</span><span class="o">.</span><span class="n">origin_x</span><span class="p">,</span> <span class="n">dataset_ref</span><span class="o">.</span><span class="n">origin_y</span><span class="p">,</span> <span class="n">dataset_ref</span><span class="o">.</span><span class="n">origin_z</span>

<span class="c1"># Vectors for coordinate at cell edges (x, y).</span>
<span class="c1"># These arrays define the real-world coordinates of the grid cell boundaries.</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">origin_x</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="n">origin_y</span>

<span class="c1"># Vectors for coordinates at cell centers (xc, yc).</span>
<span class="c1"># These arrays define the real-world coordinates of the center of each grid cell.</span>
<span class="n">xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">origin_x</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">/</span> <span class="mi">2</span>
<span class="n">yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="n">origin_y</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">/</span> <span class="mi">2</span>

<span class="c1"># `origin_time`: The base time for the simulation, typically a string.</span>
<span class="n">origin_time</span> <span class="o">=</span> <span class="n">dataset_ref</span><span class="o">.</span><span class="n">origin_time</span>
<span class="c1"># `time_step`: The time interval between consecutive simulation output steps, in seconds.</span>
<span class="n">time_step</span> <span class="o">=</span> <span class="mi">600</span>  <span class="c1"># Default PALM output time step (10 minutes).</span>
<span class="c1"># `nt`: Total number of time steps in the dataset.</span>
<span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dataset_ref</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">center_yticks</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adjusts the vertical alignment of y-axis tick labels to be centered.</span>

<span class="sd">    Args:</span>
<span class="sd">        ax (matplotlib.axes.Axes): The axes object of the plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the current y-tick positions and generate corresponding labels.</span>
    <span class="n">tick_positions</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span>
    <span class="n">tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pos</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">tick_positions</span><span class="p">]</span> <span class="c1"># Format to two decimal places.</span>
    
    <span class="c1"># Set the tick positions explicitly using `FixedLocator` to prevent Matplotlib from auto-adjusting.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">FixedLocator</span><span class="p">(</span><span class="n">tick_positions</span><span class="p">))</span>
    
    <span class="c1"># Set the y-tick labels with centered vertical alignment, and specify rotation and font size.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">tick_labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_date_day</span><span class="p">(</span><span class="n">time_index</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines the simulation day (14 or 15) based on the time index,</span>
<span class="sd">    assuming 10-minute time steps where 144 steps represent 24 hours.</span>

<span class="sd">    Args:</span>
<span class="sd">        time_index (int): The time step index (0-indexed).</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The day number (14 for the first 24 hours, 15 for the next).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 144 time steps = 144 * 10 minutes = 1440 minutes = 24 hours.</span>
    <span class="k">if</span> <span class="n">time_index</span> <span class="o">&lt;</span> <span class="mi">144</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">14</span> <span class="c1"># First day (June 14th)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">15</span> <span class="c1"># Second day (June 15th)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_extents</span><span class="p">(</span><span class="n">gdf_combined</span><span class="p">,</span> <span class="n">location_id</span><span class="p">,</span> <span class="n">increased_distance</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the array indices (extents) for a given geographical polygon (AOI)</span>
<span class="sd">    with an optional buffer distance.</span>

<span class="sd">    Args:</span>
<span class="sd">        gdf_combined (geopandas.GeoDataFrame): GeoDataFrame containing all AOI polygons.</span>
<span class="sd">        location_id (int): Index of the specific AOI in gdf_combined.</span>
<span class="sd">        increased_distance (int): The buffer distance in grid cells to expand the AOI.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple (x_low, y_low, x_high, y_high) representing the array indices</span>
<span class="sd">               of the bounding box for the buffered AOI, clamped to the simulation domain boundaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract the polygon geometry for the given location ID.</span>
    <span class="n">polygon_aug</span> <span class="o">=</span> <span class="n">gdf_combined</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">location_id</span><span class="p">]</span>
    <span class="n">polygon</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">geometry</span>
    <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">bounds</span>

    <span class="c1"># Convert geographic coordinates to array indices (assuming dx = dy).</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">min_x</span> <span class="o">-</span> <span class="n">origin_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">dx</span><span class="p">)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">min_y</span> <span class="o">-</span> <span class="n">origin_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">dy</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">origin_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">dx</span><span class="p">)</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">origin_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">dy</span><span class="p">)</span>

    <span class="c1"># Calculate half-window for the increased distance.</span>
    <span class="n">half_window</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">increased_distance</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Apply the buffer to the extents.</span>
    <span class="n">x_low</span><span class="p">,</span> <span class="n">x_high</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">half_window</span><span class="p">,</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">half_window</span>
    <span class="n">y_low</span><span class="p">,</span> <span class="n">y_high</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">half_window</span><span class="p">,</span> <span class="n">y2</span> <span class="o">+</span> <span class="n">half_window</span>

    <span class="c1"># Clamp the extents to the simulation domain boundaries (0 to nx/ny).</span>
    <span class="c1"># Ensures that the extracted region does not go out of bounds of the simulation grid.</span>
    <span class="n">x_low</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_low</span><span class="p">)</span>
    <span class="n">y_low</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_low</span><span class="p">)</span>
    <span class="n">x_high</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">x_high</span><span class="p">)</span> <span class="c1"># Use nx for x_high boundary.</span>
    <span class="n">y_high</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">y_high</span><span class="p">)</span> <span class="c1"># Use ny for y_high boundary.</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">x_low</span><span class="p">,</span> <span class="n">y_low</span><span class="p">,</span> <span class="n">x_high</span><span class="p">,</span> <span class="n">y_high</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_north_arrow_and_scale_bar</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a north arrow and a customizable scale bar to the current matplotlib axes.</span>
<span class="sd">    The positions are hardcoded for the specific simulation domain of Konstanz.</span>

<span class="sd">    Args:</span>
<span class="sd">        ax (matplotlib.axes.Axes): The axes object to add the arrow and scale bar to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Hardcoded top-right coordinates for the north arrow position (adjust as needed for different plots/domains).</span>
    <span class="n">top_right_x</span> <span class="o">=</span> <span class="mi">513390</span>
    <span class="n">top_right_y</span> <span class="o">=</span> <span class="mi">5278890</span>
    
    <span class="c1"># Create the north arrow as a FancyArrowPatch.</span>
    <span class="n">arrow</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">FancyArrowPatch</span><span class="p">((</span><span class="n">top_right_x</span><span class="p">,</span> <span class="n">top_right_y</span> <span class="o">-</span> <span class="mi">40</span><span class="p">),</span> <span class="p">(</span><span class="n">top_right_x</span><span class="p">,</span> <span class="n">top_right_y</span><span class="p">),</span>
                                    <span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">mutation_scale</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="c1"># Add &#39;N&#39; text near the arrow.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">top_right_x</span><span class="p">,</span> <span class="n">top_right_y</span> <span class="o">-</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">arrow</span><span class="p">)</span>    

    <span class="c1"># Hardcoded bottom-right coordinates for the scale bar position.</span>
    <span class="n">scale_bar_x</span> <span class="o">=</span> <span class="mi">513250</span>
    <span class="n">scale_bar_y</span> <span class="o">=</span> <span class="mi">5278410</span>
    
    <span class="n">scale_bar_length_meters</span> <span class="o">=</span> <span class="mi">150</span>  <span class="c1"># Total length of the scale bar.</span>
    <span class="n">scale_bar_segment_length</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Length of each alternating black/white segment.</span>
    
    <span class="c1"># Create the scale bar as a collection of alternating segments.</span>
    <span class="n">num_segments</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scale_bar_length_meters</span> <span class="o">/</span> <span class="n">scale_bar_segment_length</span><span class="p">)</span>
    <span class="n">num_labels</span> <span class="o">=</span> <span class="n">num_segments</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># Number of labels (0m, 50m, 100m, 150m).</span>
    <span class="n">segment_width</span> <span class="o">=</span> <span class="n">scale_bar_length_meters</span> <span class="o">/</span> <span class="n">num_segments</span> <span class="c1"># Width of each segment.</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_segments</span><span class="p">):</span>
        <span class="c1"># Alternate colors for segments.</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">segment_color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>  <span class="c1"># Black for even segments.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">segment_color</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>  <span class="c1"># White for odd segments.</span>
        
        <span class="n">segment_x</span> <span class="o">=</span> <span class="n">scale_bar_x</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">segment_width</span> <span class="c1"># X-coordinate for the start of the segment.</span>
        <span class="c1"># Create a rectangle patch for each segment.</span>
        <span class="n">scale_bar_segment</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">segment_x</span><span class="p">,</span> <span class="n">scale_bar_y</span><span class="p">),</span> <span class="n">segment_width</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">segment_color</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">scale_bar_segment</span><span class="p">)</span>
    
    <span class="c1"># Add labels (0m, 50m, 100m, etc.) to the scale bar.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_labels</span><span class="p">):</span>
        <span class="n">scale_bar_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="o">*</span><span class="n">scale_bar_segment_length</span><span class="si">}</span><span class="s1">m&#39;</span> <span class="c1"># Label text.</span>
        <span class="n">text_x</span> <span class="o">=</span> <span class="n">scale_bar_x</span> <span class="o">+</span> <span class="n">scale_bar_segment_length</span> <span class="o">*</span> <span class="n">i</span> <span class="c1"># X-coordinate for label.</span>
        <span class="n">text_y</span> <span class="o">=</span> <span class="n">scale_bar_y</span> <span class="o">+</span> <span class="mi">25</span> <span class="c1"># Y-coordinate for label (slightly above the bar).</span>
        
        <span class="c1"># Add text label with a white background bbox for visibility.</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">text_x</span><span class="p">,</span> <span class="n">text_y</span><span class="p">,</span> <span class="n">scale_bar_label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round, pad=0.1&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="extract-variable-data-and-define-areas-of-interest-aois">
<h2>6. Extract Variable Data and Define Areas of Interest (AOIs)<a class="headerlink" href="#extract-variable-data-and-define-areas-of-interest-aois" title="Link to this heading"></a></h2>
<p>This section loads the selected variable data from both simulation scenarios and reads shapefiles defining specific Areas of Interest (AOIs). These AOIs will be used to extract relevant data subsets for statistical analysis and comparison. Predefined lists for scenario names and AOI labels are also set up.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load `variable_data_1` and `variable_data_2` for the `test_variable` from the respective datasets.</span>
<span class="n">variable_data_1</span> <span class="o">=</span> <span class="n">dataset_1</span><span class="p">[</span><span class="n">test_variable</span><span class="p">]</span>
<span class="n">variable_data_2</span> <span class="o">=</span> <span class="n">dataset_2</span><span class="p">[</span><span class="n">test_variable</span><span class="p">]</span>

<span class="c1"># Store them in a list for easy iteration.</span>
<span class="n">variable_datas</span> <span class="o">=</span> <span class="p">[</span><span class="n">variable_data_1</span><span class="p">,</span> <span class="n">variable_data_2</span><span class="p">]</span>

<span class="c1"># Define names for the simulation scenarios, to be used in labels and legends.</span>
<span class="n">sim_scenarions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Baseline (BS)&#39;</span><span class="p">,</span> <span class="s1">&#39;Scenario 1 (S1)&#39;</span><span class="p">]</span>
<span class="n">sim_scene</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BS&#39;</span><span class="p">,</span> <span class="s1">&#39;S1&#39;</span><span class="p">]</span>

<span class="c1"># Define paths to shapefiles containing AOI definitions.</span>
<span class="c1"># `shapefile_path_child_ii`: For &quot;Child II&quot; AOIs.</span>
<span class="n">shapefile_path_child_ii</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;./Data/shapefiles/03_AOI_Child_II.shp&quot;</span>
<span class="c1"># `shapefile_path_uhi_study`: For Urban Heat Island (UHI) study AOIs.</span>
<span class="n">shapefile_path_uhi_study</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;./Data/shapefiles/UHI_aoi_study_fitted.shp&quot;</span>

<span class="c1"># Read the shapefiles into GeoDataFrames.</span>
<span class="n">gdf_child</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">shapefile_path_child_ii</span><span class="p">)</span>
<span class="n">gdf_uhi</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">shapefile_path_uhi_study</span><span class="p">)</span>

<span class="c1"># Combine the GeoDataFrames into a single GeoDataFrame for unified indexing of all AOIs.</span>
<span class="n">gdf_combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gdf_child</span><span class="p">,</span> <span class="n">gdf_uhi</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Define lists of location names and AOI names, corresponding to the combined GeoDataFrame.</span>
<span class="c1"># These will be used for labeling plots and tables.</span>
<span class="n">location_name_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Overall&#39;</span><span class="p">,</span> <span class="s1">&#39;Stephansplatz&#39;</span><span class="p">,</span> <span class="s1">&#39;Markstaette&#39;</span><span class="p">,</span> <span class="s1">&#39;Augustinerplatz&#39;</span><span class="p">]</span>
<span class="n">aoi_name_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Overall&#39;</span><span class="p">,</span> <span class="s1">&#39;AOI1&#39;</span><span class="p">,</span> <span class="s1">&#39;AOI2&#39;</span><span class="p">,</span> <span class="s1">&#39;AOI3&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize global variables to store the overall maximum and minimum values.</span>
<span class="c1"># `value_maximum` is set to 0, `value_minimum` is set to a very large number to ensure any real value updates it.</span>
<span class="k">global</span> <span class="n">value_maximum</span><span class="p">,</span> <span class="n">value_minimum</span>
<span class="n">value_maximum</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">value_minimum</span> <span class="o">=</span> <span class="mi">999999</span>

<span class="c1"># Iterate through all available time steps.</span>
<span class="k">for</span> <span class="n">time_index_test</span> <span class="ow">in</span> <span class="n">time_sequence</span><span class="p">:</span>
    <span class="c1"># Extract data for the current time step from `variable_data_1` (Baseline).</span>
    <span class="c1"># Assuming `variable_data_1` has dimensions (time, z, y, x) or (time, y, x).</span>
    <span class="c1"># If 4D, `[time_index_test, 0, :, :]` extracts the 2D slice at z=0. If 3D, `[time_index_test, :, :]`.\n&quot;,</span>
    <span class="n">value_test_1</span> <span class="o">=</span> <span class="n">variable_data_1</span><span class="p">[</span><span class="n">time_index_test</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> 
    <span class="c1"># Apply the 2D building mask to exclude values within buildings.\n&quot;,</span>
    <span class="n">value_test_1</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">buildings_2d_data</span><span class="o">.</span><span class="n">mask</span>

    <span class="c1"># Extract data for the current time step from `variable_data_2` (Scenario 1).\n&quot;,</span>
    <span class="n">value_test_2</span> <span class="o">=</span> <span class="n">variable_data_2</span><span class="p">[</span><span class="n">time_index_test</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">value_test_2</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">buildings_2d_data</span><span class="o">.</span><span class="n">mask</span>

    <span class="c1"># Find the maximum and minimum non-masked values for the current time step across both scenarios.\n&quot;,</span>
    <span class="n">max_value_test</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">value_test_1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">value_test_2</span><span class="p">))</span>
    <span class="n">min_value_test</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">value_test_1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">value_test_2</span><span class="p">))</span>

    <span class="c1"># Update the global `value_maximum` if the current `max_value_test` is greater.\n&quot;,</span>
    <span class="k">if</span> <span class="n">value_maximum</span> <span class="o">&lt;=</span> <span class="n">max_value_test</span><span class="p">:</span>
        <span class="n">value_maximum</span> <span class="o">=</span> <span class="n">max_value_test</span>
    <span class="c1"># Update the global `value_minimum` if the current `min_value_test` is smaller.\n&quot;,</span>
    <span class="k">if</span> <span class="n">value_minimum</span> <span class="o">&gt;=</span> <span class="n">min_value_test</span><span class="p">:</span>
        <span class="n">value_minimum</span> <span class="o">=</span> <span class="n">min_value_test</span>

<span class="c1"># Print the final global maximum and minimum values found.\n&quot;,</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overall Maximum Temperature: </span><span class="si">{</span><span class="n">value_maximum</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overall Minimum Temperature: </span><span class="si">{</span><span class="n">value_minimum</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Overall Maximum Temperature: 34.54
Overall Minimum Temperature: 13.89
</pre></div>
</div>
</div>
</div>
</section>
<section id="define-time-periods-for-analysis">
<h2>7. Define Time Periods for Analysis<a class="headerlink" href="#define-time-periods-for-analysis" title="Link to this heading"></a></h2>
<p>This section defines specific time periods (day and night) for analysis by identifying their corresponding start and end time steps within the simulation. These time steps are then used to create lists of indices that will be used for aggregating data, allowing for focused analysis of diurnal and nocturnal temperature patterns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define start and end times for &#39;day&#39; periods across two simulated days.</span>
<span class="c1"># These times are used to slice the time series data for day-time analysis.</span>
<span class="n">start_time_day</span> <span class="o">=</span> <span class="s1">&#39;12:00&#39;</span>
<span class="n">end_time_day</span> <span class="o">=</span> <span class="s1">&#39;18:00&#39;</span>

<span class="c1"># Define start and end times for &#39;night&#39; periods across the first simulated night.</span>
<span class="c1"># These times are used for nocturnal analysis.</span>
<span class="n">start_time_night</span> <span class="o">=</span> <span class="s1">&#39;21:30&#39;</span>
<span class="n">end_time_night</span> <span class="o">=</span> <span class="s1">&#39;29:10&#39;</span> <span class="c1"># Note: 29:10 is 05:10 on the second day</span>

<span class="c1"># Convert human-readable times to their corresponding time step indices for Day 1.</span>
<span class="n">start_day_1</span> <span class="o">=</span> <span class="n">time_sequence_all</span><span class="p">[</span><span class="n">time_equivalent_all</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">start_time_day</span><span class="p">)]</span>
<span class="n">end_day_1</span> <span class="o">=</span> <span class="n">time_sequence_all</span><span class="p">[</span><span class="n">time_equivalent_all</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">end_time_day</span><span class="p">)]</span>

<span class="c1"># Convert human-readable times to their corresponding time step indices for Day 2.</span>
<span class="c1"># Adding 24 to the hour for Day 2 ensures correct indexing of the extended time equivalent list.</span>
<span class="n">start_day_2</span> <span class="o">=</span> <span class="n">time_sequence_all</span><span class="p">[</span><span class="n">time_equivalent_all</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">start_time_day</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="mi">24</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">start_time_day</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>
<span class="n">end_day_2</span> <span class="o">=</span> <span class="n">time_sequence_all</span><span class="p">[</span><span class="n">time_equivalent_all</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">end_time_day</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="mi">24</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">end_time_day</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>

<span class="c1"># Convert human-readable times to their corresponding time step indices for Night 1.</span>
<span class="n">start_night_1</span> <span class="o">=</span> <span class="n">time_sequence_all</span><span class="p">[</span><span class="n">time_equivalent_all</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">start_time_night</span><span class="p">)]</span>
<span class="n">end_night_1</span> <span class="o">=</span> <span class="n">time_sequence_all</span><span class="p">[</span><span class="n">time_equivalent_all</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">end_time_night</span><span class="p">)]</span>

<span class="c1"># Create lists of time step indices for each defined period.</span>
<span class="n">list_day_1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_day_1</span><span class="p">,</span> <span class="n">end_day_1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">list_day_2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_day_2</span><span class="p">,</span> <span class="n">end_day_2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">list_night_1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_night_1</span><span class="p">,</span> <span class="n">end_night_1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Day 1: Start index </span><span class="si">{</span><span class="n">start_day_1</span><span class="si">}</span><span class="s2"> (time </span><span class="si">{</span><span class="n">time_equivalent_all</span><span class="p">[</span><span class="n">start_day_1</span><span class="p">]</span><span class="si">}</span><span class="s2">) to end index </span><span class="si">{</span><span class="n">end_day_1</span><span class="si">}</span><span class="s2"> (time </span><span class="si">{</span><span class="n">time_equivalent_all</span><span class="p">[</span><span class="n">end_day_1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Day 2: Start index </span><span class="si">{</span><span class="n">start_day_2</span><span class="si">}</span><span class="s2"> (time </span><span class="si">{</span><span class="n">time_equivalent_all</span><span class="p">[</span><span class="n">start_day_2</span><span class="p">]</span><span class="si">}</span><span class="s2">) to end index </span><span class="si">{</span><span class="n">end_day_2</span><span class="si">}</span><span class="s2"> (time </span><span class="si">{</span><span class="n">time_equivalent_all</span><span class="p">[</span><span class="n">end_day_2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Night 1: Start index </span><span class="si">{</span><span class="n">start_night_1</span><span class="si">}</span><span class="s2"> (time </span><span class="si">{</span><span class="n">time_equivalent_all</span><span class="p">[</span><span class="n">start_night_1</span><span class="p">]</span><span class="si">}</span><span class="s2">) to end index </span><span class="si">{</span><span class="n">end_night_1</span><span class="si">}</span><span class="s2"> (time </span><span class="si">{</span><span class="n">time_equivalent_all</span><span class="p">[</span><span class="n">end_night_1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Day 1: Start index 71 (time 12:00) to end index 107 (time 18:00)
Day 2: Start index 215 (time 36:00) to end index 251 (time 42:00)
Night 1: Start index 128 (time 21:30) to end index 174 (time 29:10)
</pre></div>
</div>
</div>
</div>
</section>
<section id="compute-mean-temperature-maps">
<h2>8. Compute Mean Temperature Maps<a class="headerlink" href="#compute-mean-temperature-maps" title="Link to this heading"></a></h2>
<p>This section computes 2D mean temperature maps for the defined day and night periods for both the Baseline and Scenario 1 simulations. It iterates through the selected time step lists, extracts the corresponding 2D data slices, masks out building areas, and then calculates the mean temperature for each grid cell across the specified time window. These mean maps are essential for visualizing spatial temperature distributions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize lists to store 2D temperature data for specified time periods and scenarios.</span>
<span class="c1"># `band_values1` and `band_values2` are assumed to be 3D arrays (time, y, x) or (time, z, y, x).</span>
<span class="c1"># `[:, 0, :, :]` is used to select the 2D slice if the data is 4D (e.g., at z=0).</span>
<span class="n">band_values1</span> <span class="o">=</span> <span class="n">dataset_1</span><span class="p">[</span><span class="n">test_variable</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
<span class="n">band_values2</span> <span class="o">=</span> <span class="n">dataset_2</span><span class="p">[</span><span class="n">test_variable</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

<span class="n">values_temp_day1_bs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">values_temp_day1_s1</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">values_temp_day2_bs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">values_temp_day2_s1</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">values_temp_night1_bs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">values_temp_night1_s1</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Extract and append 2D temperature data for Day 1 (Baseline and Scenario 1).</span>
<span class="k">for</span> <span class="n">time_index_temp</span> <span class="ow">in</span> <span class="n">list_day_1</span><span class="p">:</span>
    <span class="c1"># `.filled(0)` replaces masked values with 0 before appending. This might affect mean if 0 is a valid temp.</span>
    <span class="c1"># A more robust approach for masked data might be to average masked arrays directly.</span>
    <span class="n">values_temp_day1_bs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_values1</span><span class="p">[</span><span class="n">time_index_temp</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">values_temp_day1_s1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_values2</span><span class="p">[</span><span class="n">time_index_temp</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    
<span class="c1"># Extract and append 2D temperature data for Day 2 (Baseline and Scenario 1).</span>
<span class="k">for</span> <span class="n">time_index_temp</span> <span class="ow">in</span> <span class="n">list_day_2</span><span class="p">:</span>
    <span class="n">values_temp_day2_bs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_values1</span><span class="p">[</span><span class="n">time_index_temp</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">values_temp_day2_s1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_values2</span><span class="p">[</span><span class="n">time_index_temp</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

<span class="c1"># Extract and append 2D temperature data for Night 1 (Baseline and Scenario 1).</span>
<span class="k">for</span> <span class="n">time_index_temp</span> <span class="ow">in</span> <span class="n">list_night_1</span><span class="p">:</span>
    <span class="n">values_temp_night1_bs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_values1</span><span class="p">[</span><span class="n">time_index_temp</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">values_temp_night1_s1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_values2</span><span class="p">[</span><span class="n">time_index_temp</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

<span class="c1"># Convert lists of 2D arrays into 3D NumPy arrays for efficient mean calculation.</span>
<span class="n">values_temp_day1_bs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values_temp_day1_bs</span><span class="p">)</span>
<span class="n">values_temp_day1_s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values_temp_day1_s1</span><span class="p">)</span>

<span class="n">values_temp_day2_bs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values_temp_day2_bs</span><span class="p">)</span>
<span class="n">values_temp_day2_s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values_temp_day2_s1</span><span class="p">)</span>

<span class="n">values_temp_night1_bs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values_temp_night1_bs</span><span class="p">)</span>
<span class="n">values_temp_night1_s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values_temp_night1_s1</span><span class="p">)</span>

<span class="c1"># Calculate the mean temperature for each grid cell across the time dimension (axis=0).</span>
<span class="n">mean_values_temp_day1_bs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values_temp_day1_bs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mean_values_temp_day1_s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values_temp_day1_s1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">mean_values_temp_day2_bs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values_temp_day2_bs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mean_values_temp_day2_s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values_temp_day2_s1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">mean_values_temp_night1_bs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values_temp_night1_bs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mean_values_temp_night1_s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values_temp_night1_s1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualize-mean-temperature-heatmaps">
<h2>9. Visualize Mean Temperature Heatmaps<a class="headerlink" href="#visualize-mean-temperature-heatmaps" title="Link to this heading"></a></h2>
<p><strong>(Day 1 and Day 2)</strong></p>
<p>This section generates heatmaps to visualize the mean 2-meter air temperature for both Baseline and Scenario 1 during daytime periods of Day 1 and Day 2. The plots include:</p>
<p>Temperature Heatmaps: Displaying spatial temperature distribution using a turbo colormap.
AOI Overlays: Outlining predefined Areas of Interest (AOIs) with buffers.
Statistical Tables: Summarizing mean temperatures for the overall domain and specific AOIs.
Aesthetic Enhancements: Custom color bars, grid lines, and geographic elements (north arrow, scale bar) for improved interpretation.
The visualizations help to quickly identify hot and cold spots and the general temperature patterns in the simulated domain for each scenario and day.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare lists of mean temperature arrays for plotting (Day 1: Baseline and Scenario 1).</span>
<span class="n">list_to_plot_day1</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean_values_temp_day1_bs</span><span class="p">,</span> <span class="n">mean_values_temp_day1_s1</span><span class="p">]</span>
<span class="c1"># Apply the building mask to these arrays to exclude non-atmospheric grid cells.</span>
<span class="n">list_to_plot_day1_masked</span> <span class="o">=</span> <span class="p">[</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">list_to_plot_day1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask</span><span class="o">=~</span><span class="n">buildings_2d_data</span><span class="o">.</span><span class="n">mask</span><span class="p">),</span>
                            <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">list_to_plot_day1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mask</span><span class="o">=~</span><span class="n">buildings_2d_data</span><span class="o">.</span><span class="n">mask</span><span class="p">)]</span>

<span class="c1"># Titles for the subplots.</span>
<span class="n">list_of_titles_day1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BS, 2023-06-14 +01&#39;</span><span class="p">,</span> <span class="s1">&#39;S1, 2023-06-14 +01&#39;</span><span class="p">]</span>

<span class="c1"># Determine the overall min/max temperature values across both masked datasets for consistent color scaling.</span>
<span class="n">value_max_day1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">list_to_plot_day1_masked</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">list_to_plot_day1_masked</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">value_min_day1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">list_to_plot_day1_masked</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">list_to_plot_day1_masked</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="c1"># Define fixed min/max for color scale and interval for tick marks.</span>
<span class="n">vmin</span> <span class="o">=</span> <span class="mi">19</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">interval_temp</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Calculate the number of intervals for the color bar ticks.</span>
<span class="n">count_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">interval_temp</span><span class="p">)</span>

<span class="c1"># --- Plotting for Day 1 ---</span>
<span class="c1"># Create a figure and two subplots (1 row, 2 columns) for the heatmaps.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="c1"># Adjust subplot parameters for a tight layout, leaving space for the main title.</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
<span class="c1"># Set global font size for the plot.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>

<span class="c1"># Set the main title of the plot.</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mittlere 2-m Lufttemperatur in </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2"> (Day 1)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="c1"># Iterate through each scenario&#39;s data for plotting.</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">variable_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_to_plot_day1_masked</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># Get the current subplot axes.</span>

    <span class="c1"># Define the colormap for the heatmap.</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;turbo&#39;</span><span class="p">)</span> <span class="c1"># &#39;turbo&#39; is a good choice for continuous data.</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;#474747&#39;</span><span class="p">)</span>     <span class="c1"># Set color for masked (building) areas to dark grey.</span>

    <span class="c1"># Create a qualitative colormap from the sequential &#39;turbo&#39; colormap.</span>
    <span class="c1"># This is done by taking discrete colors from the continuous colormap.</span>
    <span class="n">num_colors</span> <span class="o">=</span> <span class="n">count_interval</span>
    <span class="n">sequential_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;turbo&#39;</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">sequential_cmap</span><span class="p">(</span><span class="n">j</span> <span class="o">/</span> <span class="n">num_colors</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_colors</span><span class="p">)]</span>
    <span class="n">qualitative_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
    <span class="n">qualitative_cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;#474747&#39;</span><span class="p">)</span> <span class="c1"># Ensure masked areas are consistent.</span>

    <span class="c1"># Plot the 2D temperature data as a pseudocolor mesh.</span>
    <span class="n">pcm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">variable_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">qualitative_cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    
    <span class="c1"># Extract raw values from the masked array for statistics (excluding masked data).</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">variable_data</span><span class="p">[:,:]</span>
    
    <span class="c1"># Define a buffer distance for AOI plotting (in grid cells).</span>
    <span class="n">buffer_distance</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="c1"># Create a buffered GeoDataFrame for AOI visualization.</span>
    <span class="n">buffered_gdf</span> <span class="o">=</span> <span class="n">gdf_uhi</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">buffered_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffered_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer_distance</span><span class="p">,</span> <span class="n">join_style</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Plot the buffered AOIs with a transparent fill, white edges, and a hatch pattern.</span>
    <span class="n">buffered_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;//&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate mean temperature within each AOI.</span>
    <span class="n">aoi_uhi_mean</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf_uhi</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">bounds</span>
        <span class="c1"># Convert geographic bounds to array indices.</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">min_x</span><span class="o">-</span><span class="n">origin_x</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">min_y</span><span class="o">-</span><span class="n">origin_y</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_x</span><span class="o">-</span><span class="n">origin_x</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_y</span><span class="o">-</span><span class="n">origin_y</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">)</span>

        <span class="c1"># Extract values within the AOI, including the buffer.</span>
        <span class="c1"># The `get_extents` function could be used here for more robust boundary handling.</span>
        <span class="n">value_mean_polygon</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">y1</span><span class="o">-</span><span class="n">buffer_distance</span><span class="p">:</span><span class="n">y2</span><span class="o">+</span><span class="n">buffer_distance</span><span class="p">,</span> <span class="n">x1</span><span class="o">-</span><span class="n">buffer_distance</span><span class="p">:</span><span class="n">x2</span><span class="o">+</span><span class="n">buffer_distance</span><span class="p">]</span>
        <span class="n">aoi_uhi_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value_mean_polygon</span><span class="p">)</span>
        
        <span class="c1"># Annotate each AOI with its name, positioned at the centroid with an offset.</span>
        <span class="c1"># `path_effects` adds a white stroke for better visibility against varying background colors.</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">],</span> 
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">),</span> 
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">25</span><span class="p">),</span> 
                    <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span> 
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> 
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                    <span class="n">path_effects</span><span class="o">=</span><span class="p">[</span><span class="n">pe</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)])</span>
        
    <span class="c1"># Configure grid lines for the plot.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Easting&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Northing&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Ensure the aspect ratio is equal for correct geographic representation.</span>

    <span class="c1"># Set minor ticks and grid lines for x and y axes.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="c1"># Customize tick parameters.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelrotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">center_yticks</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="c1"># Custom function to center y-tick labels.</span>

    <span class="c1"># Format y-axis major tick labels to show integers.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">y_val</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="c1"># Set subplot title.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">list_of_titles_day1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="c1"># Set plot limits (adjusting slightly beyond actual data extent for aesthetic).</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">25</span><span class="p">)</span>

    <span class="c1"># Create a color bar for the heatmap.</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;4%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span> <span class="c1"># Position color bar ticks at the top.</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2-m Lufttemperatur (</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">LinearLocator</span><span class="p">(</span><span class="n">numticks</span><span class="o">=</span><span class="n">count_interval</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Set major ticks for the color bar.</span>

    <span class="c1"># Create a table summarizing mean temperatures within the parent domain and AOIs.</span>
    <span class="n">table_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;Mittelwert Parent (KN Altstadt)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">variable_data</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mittelwert AOI1 (</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">aoi_uhi_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mittelwert AOI2 (</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">aoi_uhi_mean</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mittelwert AOI3 (</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">aoi_uhi_mean</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">cellText</span><span class="o">=</span><span class="n">table_data</span><span class="p">,</span>
                     <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                     <span class="n">cellLoc</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                     <span class="n">colWidths</span><span class="o">=</span><span class="p">[</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
                     <span class="n">edges</span><span class="o">=</span><span class="s1">&#39;open&#39;</span><span class="p">,</span>
                     <span class="n">bbox</span><span class="o">=</span><span class="p">[</span><span class="mf">0.195</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.225</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">])</span> <span class="c1"># Position the table below the plot.</span>
    <span class="n">table</span><span class="o">.</span><span class="n">auto_set_font_size</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    
    <span class="n">plot_north_arrow_and_scale_bar</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="c1"># Add north arrow and scale bar to each subplot.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/66c5f938d4eda95c102b8c2cc3d1b8378484d4386633884a20619ecd26236149.png" src="../_images/66c5f938d4eda95c102b8c2cc3d1b8378484d4386633884a20619ecd26236149.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare lists of mean temperature arrays for plotting (Day 2: Baseline and Scenario 1).</span>
<span class="n">list_to_plot_day2</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean_values_temp_day2_bs</span><span class="p">,</span> <span class="n">mean_values_temp_day2_s1</span><span class="p">]</span>
<span class="c1"># Apply the building mask to these arrays to exclude non-atmospheric grid cells.</span>
<span class="n">list_to_plot_day2_masked</span> <span class="o">=</span> <span class="p">[</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">list_to_plot_day2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask</span><span class="o">=~</span><span class="n">buildings_2d_data</span><span class="o">.</span><span class="n">mask</span><span class="p">),</span>
                            <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">list_to_plot_day2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mask</span><span class="o">=~</span><span class="n">buildings_2d_data</span><span class="o">.</span><span class="n">mask</span><span class="p">)]</span>

<span class="c1"># Titles for the subplots.</span>
<span class="n">list_of_titles_day2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BS, 2023-06-15 +01&#39;</span><span class="p">,</span> <span class="s1">&#39;S1, 2023-06-15 +01&#39;</span><span class="p">]</span>

<span class="c1"># Determine the overall min/max temperature values across both masked datasets for consistent color scaling.</span>
<span class="n">value_max_day2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">list_to_plot_day2_masked</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">list_to_plot_day2_masked</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">value_min_day2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">list_to_plot_day2_masked</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">list_to_plot_day2_masked</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="c1"># Define fixed min/max for color scale and interval for tick marks.</span>
<span class="n">vmin</span> <span class="o">=</span> <span class="mi">19</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">interval_temp</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Calculate the number of intervals for the color bar ticks.</span>
<span class="n">count_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">interval_temp</span><span class="p">)</span>

<span class="c1"># --- Plotting for Day 2 ---</span>
<span class="c1"># Create a figure and two subplots (1 row, 2 columns) for the heatmaps.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="c1"># Adjust subplot parameters for a tight layout, leaving space for the main title.</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
<span class="c1"># Set global font size for the plot.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>

<span class="c1"># Set the main title of the plot.</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mittlere 2-m Lufttemperatur in </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2"> (Day 2)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="c1"># Iterate through each scenario&#39;s data for plotting.</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">variable_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_to_plot_day2_masked</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># Get the current subplot axes.</span>

    <span class="c1"># Define the colormap for the heatmap.</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;turbo&#39;</span><span class="p">)</span> <span class="c1"># &#39;turbo&#39; is a good choice for continuous data.</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;#474747&#39;</span><span class="p">)</span>     <span class="c1"># Set color for masked (building) areas to dark grey.</span>

    <span class="c1"># Create a qualitative colormap from the sequential &#39;turbo&#39; colormap.</span>
    <span class="c1"># This is done by taking discrete colors from the continuous colormap.</span>
    <span class="n">num_colors</span> <span class="o">=</span> <span class="n">count_interval</span>
    <span class="n">sequential_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;turbo&#39;</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">sequential_cmap</span><span class="p">(</span><span class="n">j</span> <span class="o">/</span> <span class="n">num_colors</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_colors</span><span class="p">)]</span>
    <span class="n">qualitative_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
    <span class="n">qualitative_cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;#474747&#39;</span><span class="p">)</span> <span class="c1"># Ensure masked areas are consistent.</span>

    <span class="c1"># Plot the 2D temperature data as a pseudocolor mesh.</span>
    <span class="n">pcm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">variable_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">qualitative_cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    
    <span class="c1"># Extract raw values from the masked array for statistics (excluding masked data).</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">variable_data</span><span class="p">[:,:]</span>
    
    <span class="c1"># Define a buffer distance for AOI plotting (in grid cells).</span>
    <span class="n">buffer_distance</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="c1"># Create a buffered GeoDataFrame for AOI visualization.</span>
    <span class="n">buffered_gdf</span> <span class="o">=</span> <span class="n">gdf_uhi</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">buffered_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffered_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer_distance</span><span class="p">,</span> <span class="n">join_style</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Plot the buffered AOIs with a transparent fill, white edges, and a hatch pattern.</span>
    <span class="n">buffered_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;//&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate mean temperature within each AOI.</span>
    <span class="n">aoi_uhi_mean</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf_uhi</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">bounds</span>
        <span class="c1"># Convert geographic bounds to array indices.</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">min_x</span><span class="o">-</span><span class="n">origin_x</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">min_y</span><span class="o">-</span><span class="n">origin_y</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_x</span><span class="o">-</span><span class="n">origin_x</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_y</span><span class="o">-</span><span class="n">origin_y</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">)</span>

        <span class="c1"># Extract values within the AOI, including the buffer.</span>
        <span class="c1"># The `get_extents` function could be used here for more robust boundary handling.</span>
        <span class="n">value_mean_polygon</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">y1</span><span class="o">-</span><span class="n">buffer_distance</span><span class="p">:</span><span class="n">y2</span><span class="o">+</span><span class="n">buffer_distance</span><span class="p">,</span> <span class="n">x1</span><span class="o">-</span><span class="n">buffer_distance</span><span class="p">:</span><span class="n">x2</span><span class="o">+</span><span class="n">buffer_distance</span><span class="p">]</span>
        <span class="n">aoi_uhi_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value_mean_polygon</span><span class="p">)</span>
        
        <span class="c1"># Annotate each AOI with its name, positioned at the centroid with an offset.</span>
        <span class="c1"># `path_effects` adds a white stroke for better visibility against varying background colors.</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">],</span> 
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">),</span> 
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">25</span><span class="p">),</span> 
                    <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span> 
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> 
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                    <span class="n">path_effects</span><span class="o">=</span><span class="p">[</span><span class="n">pe</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)])</span>
        
    <span class="c1"># Configure grid lines for the plot.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Easting&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Northing&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Ensure the aspect ratio is equal for correct geographic representation.</span>

    <span class="c1"># Set minor ticks and grid lines for x and y axes.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="c1"># Customize tick parameters.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelrotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">center_yticks</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="c1"># Custom function to center y-tick labels.</span>

    <span class="c1"># Format y-axis major tick labels to show integers.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">y_val</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="c1"># Set subplot title.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">list_of_titles_day2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="c1"># Set plot limits (adjusting slightly beyond actual data extent for aesthetic).</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">25</span><span class="p">)</span>

    <span class="c1"># Create a color bar for the heatmap.</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;4%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span> <span class="c1"># Position color bar ticks at the top.</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2-m Lufttemperatur (</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">LinearLocator</span><span class="p">(</span><span class="n">numticks</span><span class="o">=</span><span class="n">count_interval</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Set major ticks for the color bar.</span>

    <span class="c1"># Create a table summarizing mean temperatures within the parent domain and AOIs.</span>
    <span class="n">table_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;Mittelwert Parent (KN Altstadt)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">variable_data</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mittelwert AOI1 (</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">aoi_uhi_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mittelwert AOI2 (</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">aoi_uhi_mean</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mittelwert AOI3 (</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">aoi_uhi_mean</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">cellText</span><span class="o">=</span><span class="n">table_data</span><span class="p">,</span>
                     <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                     <span class="n">cellLoc</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                     <span class="n">colWidths</span><span class="o">=</span><span class="p">[</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
                     <span class="n">edges</span><span class="o">=</span><span class="s1">&#39;open&#39;</span><span class="p">,</span>
                     <span class="n">bbox</span><span class="o">=</span><span class="p">[</span><span class="mf">0.195</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.225</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">])</span> <span class="c1"># Position the table below the plot.</span>
    <span class="n">table</span><span class="o">.</span><span class="n">auto_set_font_size</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    
    <span class="n">plot_north_arrow_and_scale_bar</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="c1"># Add north arrow and scale bar to each subplot.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1e5b6516c4366b39ab5d81f5699840cb123ff7c35eef8fe016ab35398b814326.png" src="../_images/1e5b6516c4366b39ab5d81f5699840cb123ff7c35eef8fe016ab35398b814326.png" />
</div>
</div>
</section>
<section id="visualize-mean-temperature-heatmaps-night-1">
<h2>10. Visualize Mean Temperature Heatmaps (Night 1)<a class="headerlink" href="#visualize-mean-temperature-heatmaps-night-1" title="Link to this heading"></a></h2>
<p>This section generates heatmaps to visualize the mean 2-meter air temperature for both Baseline and Scenario 1 during the nighttime period of Night 1. Similar to the daytime plots, it includes:</p>
<ul class="simple">
<li><p>Temperature Heatmaps: Displaying spatial temperature distribution using a turbo colormap.</p></li>
<li><p>AOI Overlays: Outlining predefined Areas of Interest (AOIs) with buffers.</p></li>
<li><p>Statistical Tables: Summarizing mean temperatures for the overall domain and specific AOIs.
Aesthetic Enhancements: Custom color bars, grid lines, and geographic elements (north arrow, scale bar) for improved interpretation.</p></li>
</ul>
<p>The visualizations help to quickly identify hot and cold spots and the general temperature patterns in the simulated domain for each scenario during the night.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare lists of mean temperature arrays for plotting (Night 1: Baseline and Scenario 1).</span>
<span class="n">list_to_plot_night1</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean_values_temp_night1_bs</span><span class="p">,</span> <span class="n">mean_values_temp_night1_s1</span><span class="p">]</span>
<span class="c1"># Apply the building mask to these arrays to exclude non-atmospheric grid cells.</span>
<span class="n">list_to_plot_night1_masked</span> <span class="o">=</span> <span class="p">[</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">list_to_plot_night1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask</span><span class="o">=~</span><span class="n">buildings_2d_data</span><span class="o">.</span><span class="n">mask</span><span class="p">),</span>
                            <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">list_to_plot_night1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mask</span><span class="o">=~</span><span class="n">buildings_2d_data</span><span class="o">.</span><span class="n">mask</span><span class="p">)]</span>

<span class="c1"># Titles for the subplots.</span>
<span class="n">list_of_titles_night1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BS, 2023-06-14/15 +01&#39;</span><span class="p">,</span> <span class="s1">&#39;S1, 2023-06-14/15 +01&#39;</span><span class="p">]</span>

<span class="c1"># Determine the overall min/max temperature values across both masked datasets for consistent color scaling.</span>
<span class="n">value_max_night1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">list_to_plot_night1_masked</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">list_to_plot_night1_masked</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">value_min_night1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">list_to_plot_night1_masked</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">list_to_plot_night1_masked</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="c1"># Define fixed min/max for color scale and interval for tick marks.</span>
<span class="n">vmin</span> <span class="o">=</span> <span class="n">value_min_night1</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">value_max_night1</span>
<span class="n">interval_temp</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Calculate the number of intervals for the color bar ticks.</span>
<span class="n">count_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">interval_temp</span><span class="p">)</span>

<span class="c1"># --- Plotting for Night 1 ---</span>
<span class="c1"># Create a figure and two subplots (1 row, 2 columns) for the heatmaps.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="c1"># Adjust subplot parameters for a tight layout, leaving space for the main title.</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
<span class="c1"># Set global font size for the plot.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>

<span class="c1"># Set the main title of the plot.</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mittlere 2-m Lufttemperatur in </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2"> (Night 1)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="c1"># Iterate through each scenario&#39;s data for plotting.</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">variable_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_to_plot_night1_masked</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># Get the current subplot axes.</span>

    <span class="c1"># Define the colormap for the heatmap.</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;turbo&#39;</span><span class="p">)</span> <span class="c1"># &#39;turbo&#39; is a good choice for continuous data.</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;#474747&#39;</span><span class="p">)</span>     <span class="c1"># Set color for masked (building) areas to dark grey.</span>

    <span class="c1"># Create a qualitative colormap from the sequential &#39;turbo&#39; colormap.</span>
    <span class="c1"># This is done by taking discrete colors from the continuous colormap.</span>
    <span class="n">num_colors</span> <span class="o">=</span> <span class="n">count_interval</span>
    <span class="n">sequential_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;turbo&#39;</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">sequential_cmap</span><span class="p">(</span><span class="n">j</span> <span class="o">/</span> <span class="n">num_colors</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_colors</span><span class="p">)]</span>
    <span class="n">qualitative_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
    <span class="n">qualitative_cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;#474747&#39;</span><span class="p">)</span> <span class="c1"># Ensure masked areas are consistent.</span>

    <span class="c1"># Plot the 2D temperature data as a pseudocolor mesh.</span>
    <span class="n">pcm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">variable_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">qualitative_cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    
    <span class="c1"># Extract raw values from the masked array for statistics (excluding masked data).</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">variable_data</span><span class="p">[:,:]</span>
    
    <span class="c1"># Define a buffer distance for AOI plotting (in grid cells).</span>
    <span class="n">buffer_distance</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="c1"># Create a buffered GeoDataFrame for AOI visualization.</span>
    <span class="n">buffered_gdf</span> <span class="o">=</span> <span class="n">gdf_uhi</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">buffered_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffered_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer_distance</span><span class="p">,</span> <span class="n">join_style</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Plot the buffered AOIs with a transparent fill, white edges, and a hatch pattern.</span>
    <span class="n">buffered_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;//&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate mean temperature within each AOI.</span>
    <span class="n">aoi_uhi_mean</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf_uhi</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">bounds</span>
        <span class="c1"># Convert geographic bounds to array indices.</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">min_x</span><span class="o">-</span><span class="n">origin_x</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">min_y</span><span class="o">-</span><span class="n">origin_y</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_x</span><span class="o">-</span><span class="n">origin_x</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_y</span><span class="o">-</span><span class="n">origin_y</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">)</span>

        <span class="c1"># Extract values within the AOI, including the buffer.</span>
        <span class="c1"># The `get_extents` function could be used here for more robust boundary handling.</span>
        <span class="n">value_mean_polygon</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">y1</span><span class="o">-</span><span class="n">buffer_distance</span><span class="p">:</span><span class="n">y2</span><span class="o">+</span><span class="n">buffer_distance</span><span class="p">,</span> <span class="n">x1</span><span class="o">-</span><span class="n">buffer_distance</span><span class="p">:</span><span class="n">x2</span><span class="o">+</span><span class="n">buffer_distance</span><span class="p">]</span>
        <span class="n">aoi_uhi_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value_mean_polygon</span><span class="p">)</span>
        
        <span class="c1"># Annotate each AOI with its name, positioned at the centroid with an offset.</span>
        <span class="c1"># `path_effects` adds a white stroke for better visibility against varying background colors.</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">],</span> 
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">),</span> 
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">25</span><span class="p">),</span> 
                    <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span> 
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> 
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                    <span class="n">path_effects</span><span class="o">=</span><span class="p">[</span><span class="n">pe</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)])</span>
        
    <span class="c1"># Configure grid lines for the plot.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Easting&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Northing&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Ensure the aspect ratio is equal for correct geographic representation.</span>

    <span class="c1"># Set minor ticks and grid lines for x and y axes.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="c1"># Customize tick parameters.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelrotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">center_yticks</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="c1"># Custom function to center y-tick labels.</span>

    <span class="c1"># Format y-axis major tick labels to show integers.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">y_val</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="c1"># Set subplot title.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">list_of_titles_night1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="c1"># Set plot limits (adjusting slightly beyond actual data extent for aesthetic).</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">25</span><span class="p">)</span>

    <span class="c1"># Create a color bar for the heatmap.</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;4%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span> <span class="c1"># Position color bar ticks at the top.</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2-m Lufttemperatur (</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">LinearLocator</span><span class="p">(</span><span class="n">numticks</span><span class="o">=</span><span class="n">count_interval</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Set major ticks for the color bar.</span>

    <span class="c1"># Create a table summarizing mean temperatures within the parent domain and AOIs.</span>
    <span class="n">table_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;Mittelwert Parent (KN Altstadt)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">variable_data</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mittelwert AOI1 (</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">aoi_uhi_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mittelwert AOI2 (</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">aoi_uhi_mean</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mittelwert AOI3 (</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">aoi_uhi_mean</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">cellText</span><span class="o">=</span><span class="n">table_data</span><span class="p">,</span>
                     <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                     <span class="n">cellLoc</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                     <span class="n">colWidths</span><span class="o">=</span><span class="p">[</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
                     <span class="n">edges</span><span class="o">=</span><span class="s1">&#39;open&#39;</span><span class="p">,</span>
                     <span class="n">bbox</span><span class="o">=</span><span class="p">[</span><span class="mf">0.195</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.225</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">])</span> <span class="c1"># Position the table below the plot.</span>
    <span class="n">table</span><span class="o">.</span><span class="n">auto_set_font_size</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    
    <span class="n">plot_north_arrow_and_scale_bar</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="c1"># Add north arrow and scale bar to each subplot.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d09222134a5dc7b8c935da986488804098378d0cc263dcaeb577a32b538bb13b.png" src="../_images/d09222134a5dc7b8c935da986488804098378d0cc263dcaeb577a32b538bb13b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ## Uncomment and run to generate plots for all time sequences</span>

<span class="c1"># # time_equivalent, time_equivalent_24hr = list_to_24hour(time_sequence)</span>

<span class="c1"># for hour in range(0,48,1):</span>

<span class="c1">#     hour_index = time_sequence[hour]</span>
<span class="c1">#     hour_index</span>

<span class="c1">#     band_values1 = variable_data_1[hour_index, 0, :, :]</span>
<span class="c1">#     band_values2 = variable_data_2[hour_index, 0, :, :]</span>

<span class="c1">#     hour_list_to_plot = [band_values1, band_values2]</span>

<span class="c1">#     hour_list_to_plot_masked = [ma.array(hour_list_to_plot[0], mask=~buildings_2d_data.mask),</span>
<span class="c1">#                                 ma.array(hour_list_to_plot[1], mask=~buildings_2d_data.mask)]</span>

<span class="c1">#     value_max = max(np.nanmax(hour_list_to_plot_masked[0]), np.nanmax(hour_list_to_plot_masked[1]))</span>
<span class="c1">#     value_min = min(np.nanmin(hour_list_to_plot_masked[0]), np.nanmin(hour_list_to_plot_masked[1]))</span>

<span class="c1">#     vmin = ma.floor(value_min)</span>
<span class="c1">#     vmax = ma.ceil(value_max)</span>

<span class="c1">#     # Plotting the masked t_test_results using a heatmap</span>
<span class="c1">#     fig, axs = plt.subplots(1,2, figsize=(19, 9), facecolor=&#39;w&#39;, edgecolor=&#39;k&#39;)</span>
<span class="c1">#     fig.tight_layout(rect=[0, 0.05, 1, 0.95])</span>
<span class="c1">#     fig.suptitle(f&#39;2m Lufttemperatur {time_equivalent_24hr[hour]} &#39;, fontsize=16)</span>

<span class="c1">#     plt.rcParams.update({&#39;font.size&#39;: 15})</span>

<span class="c1">#     for i, variable_data in enumerate(hour_list_to_plot_masked):</span>
<span class="c1">#         ax = axs[i]</span>

<span class="c1">#         # Define plot color and mask color</span>
<span class="c1">#         cmap = plt.get_cmap(&#39;turbo&#39;)  # Other cmap: jet, turbo, rainbow,</span>
<span class="c1">#         cmap.set_bad(&#39;#474747&#39;)  # 474747</span>

<span class="c1">#         # Define qualitative from sequential cmap</span>
<span class="c1">#         count_interval = 16</span>
<span class="c1">#         num_colors = count_interval</span>
<span class="c1">#         sequential_cmap = plt.get_cmap(&#39;turbo&#39;)</span>
<span class="c1">#         colors = [sequential_cmap(i / num_colors) for i in range(num_colors)]</span>
<span class="c1">#         qualitative_cmap = plt.cm.colors.ListedColormap(colors)</span>
<span class="c1">#         qualitative_cmap.set_bad(&#39;#474747&#39;)</span>

<span class="c1">#         pcm = ax.pcolormesh(x,y, variable_data, cmap=qualitative_cmap, vmin=14, vmax=30)</span>
        
<span class="c1">#         # Compute statistics</span>
<span class="c1">#         values = variable_data[:,:]</span>
        
<span class="c1">#         buffer_distance = half_window_2 = 10</span>
<span class="c1">#         # Plot shapefile and calculate mean within each polygon</span>
<span class="c1">#         buffered_gdf = gdf_uhi.copy()</span>
<span class="c1">#         buffered_gdf[&#39;geometry&#39;] = buffered_gdf[&#39;geometry&#39;].buffer(buffer_distance, join_style=2)</span>
<span class="c1">#         buffered_gdf.plot(ax=ax, color=&#39;none&#39;, edgecolor=&#39;w&#39;, linewidth=1.0, alpha=1, hatch=&#39;//&#39;)</span>

<span class="c1">#         aoi_uhi_mean = []</span>
<span class="c1">#         for index, row in gdf_uhi.iterrows():</span>
<span class="c1">#             polygon = row.geometry</span>
<span class="c1">#             min_x, min_y, max_x, max_y = polygon.bounds</span>
<span class="c1">#             x1, y1, x2, y2 = int((min_x-origin_x)/dx), int((min_y-origin_y)/dx), int((max_x-origin_x)/dx), int((max_y-origin_y)/dx)</span>

<span class="c1">#             half_window = half_window_2</span>
<span class="c1">#             value_mean_polygon = values[y1-half_window:y2+half_window, x1-half_window:x2+half_window]</span>
<span class="c1">#             aoi_uhi_mean.append(value_mean_polygon)</span>
            
<span class="c1">#             ax.annotate(row[&#39;Location&#39;], </span>
<span class="c1">#                 xy=(polygon.centroid.x, min_y), </span>
<span class="c1">#                 xytext=(0,-25), </span>
<span class="c1">#                 textcoords=&quot;offset points&quot;, </span>
<span class="c1">#                 ha=&#39;center&#39;, </span>
<span class="c1">#                 fontsize=12,</span>
<span class="c1">#                 path_effects=[pe.withStroke(linewidth=3, foreground=&#39;white&#39;)])</span>
        
<span class="c1">#         ax.grid(True, linestyle=&#39;-.&#39;, linewidth=1.75, color=&#39;k&#39;, alpha=0.75)</span>
<span class="c1">#         ax.set_xlabel(&#39;Easting&#39;, fontsize=15)</span>
<span class="c1">#         ax.set_ylabel(&#39;Northing&#39;, fontsize=15)</span>
<span class="c1">#         ax.set_aspect(1)  # 1 or &#39;equal&#39;</span>

<span class="c1">#         ax.xaxis.set_minor_locator(ticker.AutoMinorLocator(n=5))</span>
<span class="c1">#         ax.xaxis.grid(which=&#39;minor&#39;, linestyle=&#39;--&#39;, linewidth=0.75, color=&#39;grey&#39;, alpha=0.4)</span>
<span class="c1">#         ax.yaxis.set_minor_locator(ticker.AutoMinorLocator(n=5))</span>
<span class="c1">#         ax.yaxis.grid(which=&#39;minor&#39;, linestyle=&#39;--&#39;, linewidth=0.75, color=&#39;grey&#39;, alpha=0.4)</span>

<span class="c1">#         ax.tick_params(axis=&#39;x&#39;, labelsize=12)</span>
<span class="c1">#         ax.tick_params(axis=&#39;y&#39;, labelrotation=90, labelsize=12, )</span>
<span class="c1">#         center_yticks(ax)</span>

<span class="c1">#         ax.yaxis.set_major_formatter(ticker.FuncFormatter(lambda y, pos: f&#39;{y:.0f}&#39;))</span>
        
<span class="c1">#         if hour &gt; 24:</span>
<span class="c1">#             ax.set_title(f&quot;{list_of_titles[i].replace(&#39;14&#39;,&#39;15&#39;)}&quot;, fontsize=12)</span>
<span class="c1">#         else:</span>
<span class="c1">#             ax.set_title(f&quot;{list_of_titles[i]}&quot;, fontsize=12)</span>
        
<span class="c1">#         ax.set_xlim(x[0]-25, x[-1]+25)</span>
<span class="c1">#         ax.set_ylim(y[0]-25, y[-1]+25)</span>

<span class="c1">#         # Create color bar</span>
<span class="c1">#         divider = make_axes_locatable(ax)</span>
<span class="c1">#         cax = divider.append_axes(&quot;right&quot;, size=&quot;4%&quot;, pad=0.15)</span>
<span class="c1">#         cb = fig.colorbar(pcm, cax=cax, extend=None, format=&#39;%.2f&#39;, spacing=&#39;uniform&#39;, )</span>
<span class="c1">#         cb.ax.tick_params(labelsize=12, rotation=0)</span>
<span class="c1">#         cb.ax.xaxis.set_ticks_position(&quot;top&quot;)</span>
<span class="c1">#         cb.ax.set_ylabel(f&quot;2-m Lufttemperatur ({unit})&quot;, fontsize=12, weight=&quot;bold&quot;)</span>
<span class="c1">#         # locator = MultipleLocator(5)</span>
<span class="c1">#         cb.ax.yaxis.set_major_locator(ticker.LinearLocator(numticks=count_interval+1))</span>
<span class="c1">#         # cb.ax.tick_params(rotation=90)</span>
<span class="c1">#         # center_yticks(cb.ax)</span>
            

<span class="c1">#     plt.savefig(f&quot;./air_temp{hour}&quot;)</span>
<span class="c1">#     plt.show()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualize-mean-temperature-difference-heatmaps-day-1-and-day-2">
<h2>11. Visualize Mean Temperature Difference Heatmaps (Day 1 and Day 2)<a class="headerlink" href="#visualize-mean-temperature-difference-heatmaps-day-1-and-day-2" title="Link to this heading"></a></h2>
<p>This section calculates and visualizes the spatial difference in mean 2-meter air temperature between Scenario 1 and Baseline for daytime periods of Day 1 and Day 2. The plots highlight areas where temperature changes are most prominent.</p>
<ul class="simple">
<li><p>Difference Heatmaps: Displaying the spatial temperature difference using a diverging colormap centered at zero, showing both cooling and warming effects.</p></li>
<li><p>AOI Overlays: Outlining predefined Areas of Interest (AOIs) with buffers.</p></li>
<li><p>Statistical Tables: Summarizing mean temperature differences for the overall domain and specific AOIs.</p></li>
<li><p>Aesthetic Enhancements: Custom color bars, grid lines, and geographic elements (north arrow, scale bar) for improved interpretation.</p></li>
</ul>
<p>The visualizations help to quickly identify areas with significant temperature impacts due to the changes introduced in Scenario 1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the difference in mean temperatures (Scenario 1 - Baseline) for each period.</span>
<span class="n">difference_values_day1</span> <span class="o">=</span> <span class="n">mean_values_temp_day1_s1</span> <span class="o">-</span> <span class="n">mean_values_temp_day1_bs</span>
<span class="n">difference_values_day2</span> <span class="o">=</span> <span class="n">mean_values_temp_day2_s1</span> <span class="o">-</span> <span class="n">mean_values_temp_day2_bs</span>
<span class="n">difference_values_night1</span> <span class="o">=</span> <span class="n">mean_values_temp_night1_s1</span> <span class="o">-</span> <span class="n">mean_values_temp_night1_bs</span>

<span class="c1"># Prepare lists of difference arrays for plotting (Day 1 and Day 2).</span>
<span class="n">list_to_plot_diff</span> <span class="o">=</span> <span class="p">[</span><span class="n">difference_values_day1</span><span class="p">,</span> <span class="n">difference_values_day2</span><span class="p">]</span>
<span class="c1"># Apply the building mask to these arrays.</span>
<span class="n">list_to_plot_diff_masked</span> <span class="o">=</span> <span class="p">[</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">list_to_plot_diff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask</span><span class="o">=~</span><span class="n">buildings_2d_data</span><span class="o">.</span><span class="n">mask</span><span class="p">),</span>
                            <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">list_to_plot_diff</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mask</span><span class="o">=~</span><span class="n">buildings_2d_data</span><span class="o">.</span><span class="n">mask</span><span class="p">)]</span>

<span class="c1"># Titles for the difference subplots.</span>
<span class="n">list_of_titles_diff</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2023-06-14 +01&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-06-15 +01&#39;</span><span class="p">]</span>

<span class="c1"># Define fixed min/max for the color scale of the difference map (centered at 0).</span>
<span class="n">vmin_diff</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span>
<span class="n">vmax_diff</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">interval_diff</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="c1"># Calculate the number of intervals for the color bar ticks.</span>
<span class="n">count_interval_diff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">vmax_diff</span> <span class="o">-</span> <span class="n">vmin_diff</span><span class="p">)</span> <span class="o">/</span> <span class="n">interval_diff</span><span class="p">)</span>

<span class="c1"># --- Plotting Mean Difference for Day 1 and Day 2 ---</span>
<span class="c1"># Create a figure and two subplots.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>

<span class="c1"># Set the main title for the difference plot.</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mittlere Differenz der 2-m Lufttemperatur (</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">variable_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_to_plot_diff_masked</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># Define a diverging colormap (&#39;coolwarm&#39;) centered at zero for differences.</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">)</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;#474747&#39;</span><span class="p">)</span>

    <span class="c1"># Plot the difference data.</span>
    <span class="n">pcm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">variable_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin_diff</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax_diff</span><span class="p">)</span>
    
    <span class="c1"># Extract raw values for statistics.</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">variable_data</span><span class="p">[:,:]</span>
    
    <span class="c1"># Define buffer distance and plot buffered AOIs.</span>
    <span class="n">buffer_distance</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">buffered_gdf</span> <span class="o">=</span> <span class="n">gdf_uhi</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">buffered_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffered_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer_distance</span><span class="p">,</span> <span class="n">join_style</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">buffered_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;//&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate mean difference within each AOI.</span>
    <span class="n">aoi_uhi_mean_diff</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf_uhi</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">min_x</span><span class="o">-</span><span class="n">origin_x</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">min_y</span><span class="o">-</span><span class="n">origin_y</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_x</span><span class="o">-</span><span class="n">origin_x</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_y</span><span class="o">-</span><span class="n">origin_y</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">)</span>

        <span class="n">value_mean_polygon</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">y1</span><span class="o">-</span><span class="n">buffer_distance</span><span class="p">:</span><span class="n">y2</span><span class="o">+</span><span class="n">buffer_distance</span><span class="p">,</span> <span class="n">x1</span><span class="o">-</span><span class="n">buffer_distance</span><span class="p">:</span><span class="n">x2</span><span class="o">+</span><span class="n">buffer_distance</span><span class="p">]</span>
        <span class="n">aoi_uhi_mean_diff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value_mean_polygon</span><span class="p">)</span>
        
        <span class="c1"># Annotate AOIs.</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">],</span> 
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">),</span> 
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">25</span><span class="p">),</span> 
                    <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span> 
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> 
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                    <span class="n">path_effects</span><span class="o">=</span><span class="p">[</span><span class="n">pe</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)])</span>

    <span class="c1"># Configure grid, labels, and ticks.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Easting&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Northing&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelrotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">center_yticks</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">y_val</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">list_of_titles_diff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">25</span><span class="p">)</span>

    <span class="c1"># Create color bar for difference map.</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;4%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2-m Lufttemperatur (</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">LinearLocator</span><span class="p">(</span><span class="n">numticks</span><span class="o">=</span><span class="n">count_interval_diff</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Create a table summarizing mean differences.</span>
    <span class="n">table_data_diff</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;Mittelwert Differenz Parent (KN Altstadt)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">variable_data</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mittelwert Differenz AOI1 (</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">aoi_uhi_mean_diff</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mittelwert Differenz AOI2 (</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">aoi_uhi_mean_diff</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mittelwert Differenz AOI3 (</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">aoi_uhi_mean_diff</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">cellText</span><span class="o">=</span><span class="n">table_data_diff</span><span class="p">,</span>
                     <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                     <span class="n">cellLoc</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                     <span class="n">colWidths</span><span class="o">=</span><span class="p">[</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
                     <span class="n">edges</span><span class="o">=</span><span class="s1">&#39;open&#39;</span><span class="p">,</span>
                     <span class="n">bbox</span><span class="o">=</span><span class="p">[</span><span class="mf">0.195</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.225</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">])</span>
    <span class="n">table</span><span class="o">.</span><span class="n">auto_set_font_size</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    
    <span class="n">plot_north_arrow_and_scale_bar</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c5a6f8d041cf40701c419ee8711198a28aae0110303b34295059696b7fcff989.png" src="../_images/c5a6f8d041cf40701c419ee8711198a28aae0110303b34295059696b7fcff989.png" />
</div>
</div>
</section>
<section id="perform-t-test-at-individual-pixels">
<h2>12. Perform T-test at Individual Pixels<a class="headerlink" href="#perform-t-test-at-individual-pixels" title="Link to this heading"></a></h2>
<p>This section performs independent t-tests for each individual grid cell (pixel) between the Baseline and Scenario 1 simulations for the defined day and night periods. The goal is to identify areas where the temperature difference is statistically significant.</p>
<ul class="simple">
<li><p>Pixel-wise T-test: Iterates through every pixel and applies scipy.stats.ttest_ind to the time series data of that pixel from both scenarios.</p></li>
<li><p>Significance Masking: Creates a 2D array where pixels are marked based on whether the null hypothesis (no significant difference) is rejected (p&lt;α) or failed to be rejected (p≥α).</p></li>
</ul>
<p>These t-test results will be used in the next section for visualization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Define the significance level (alpha) for the t-test.</span>
<span class="n">alpha_test</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="c1"># Get the spatial dimensions (number of y and x cells) from `band_values1`.</span>
<span class="n">band_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">band_values1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

<span class="c1"># Define cache file path</span>
<span class="n">cache_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;t_test_results.npz&quot;</span><span class="p">)</span>

<span class="c1"># Check if the cached file exists</span>
<span class="k">if</span> <span class="n">cache_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="c1"># Load precomputed t-test results</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cache_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">t_test_results_day1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;day1&quot;</span><span class="p">]</span>
        <span class="n">t_test_results_day2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;day2&quot;</span><span class="p">]</span>
        <span class="n">t_test_results_night1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;night1&quot;</span><span class="p">]</span>

<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Initialize 2D arrays to store t-test results for Day 1 and Day 2. </span>
    <span class="c1"># A value of 1 typically indicates &#39;Reject null&#39; (significant difference),</span>
    <span class="c1"># and 2 indicates &#39;Failed to reject null&#39; (no significant difference).</span>
    <span class="n">t_test_results_day1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">band_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">band_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">t_test_results_day2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">band_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">band_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">t_test_results_night1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">band_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">band_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># --- Perform t-test for Day 1 --- </span>
    <span class="c1"># Iterate over each pixel in the spatial domain.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">band_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># Loop through y-dimension</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">band_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># Loop through x-dimension</span>
            <span class="n">values_temp_1</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Store time series data for Baseline.</span>
            <span class="n">values_temp_2</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Store time series data for Scenario 1.</span>

            <span class="c1"># Extract time series data for the current pixel (i,j) within the Day 1 time window.</span>
            <span class="k">for</span> <span class="n">time_index_temp</span> <span class="ow">in</span> <span class="n">list_day_1</span><span class="p">:</span>
                <span class="n">temp_1</span> <span class="o">=</span> <span class="n">band_values1</span><span class="p">[</span><span class="n">time_index_temp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">temp_2</span> <span class="o">=</span> <span class="n">band_values2</span><span class="p">[</span><span class="n">time_index_temp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="n">values_temp_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_1</span><span class="p">)</span>
                <span class="n">values_temp_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_2</span><span class="p">)</span>

            <span class="c1"># Perform independent t-test (assuming unequal variances is generally safer if not known).</span>
            <span class="n">t_statistic</span><span class="p">,</span> <span class="n">p_value_ttest</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">values_temp_1</span><span class="p">,</span> <span class="n">values_temp_2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Store the result based on the p-value compared to alpha.</span>
            <span class="k">if</span> <span class="n">p_value_ttest</span> <span class="o">&lt;</span> <span class="n">alpha_test</span><span class="p">:</span>
                <span class="n">t_test_results_day1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Reject null hypothesis (significant difference).</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t_test_results_day1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Failed to reject null hypothesis (no significant difference).</span>

    <span class="c1"># --- Perform t-test for Day 2 --- </span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">band_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># Loop through y-dimension</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">band_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># Loop through x-dimension</span>
            <span class="n">values_temp_1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">values_temp_2</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Extract time series data for the current pixel (i,j) within the Day 2 time window.</span>
            <span class="k">for</span> <span class="n">time_index_temp</span> <span class="ow">in</span> <span class="n">list_day_2</span><span class="p">:</span>
                <span class="n">temp_1</span> <span class="o">=</span> <span class="n">band_values1</span><span class="p">[</span><span class="n">time_index_temp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">temp_2</span> <span class="o">=</span> <span class="n">band_values2</span><span class="p">[</span><span class="n">time_index_temp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="n">values_temp_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_1</span><span class="p">)</span>
                <span class="n">values_temp_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_2</span><span class="p">)</span>

            <span class="c1"># Perform independent t-test.</span>
            <span class="n">t_statistic</span><span class="p">,</span> <span class="n">p_value_ttest</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">values_temp_1</span><span class="p">,</span> <span class="n">values_temp_2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Store the result.</span>
            <span class="k">if</span> <span class="n">p_value_ttest</span> <span class="o">&lt;</span> <span class="n">alpha_test</span><span class="p">:</span>
                <span class="n">t_test_results_day2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t_test_results_day2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># --- Perform t-test for Night 1 --- </span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">band_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># Loop through y-dimension</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">band_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># Loop through x-dimension</span>
            <span class="n">values_temp_1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">values_temp_2</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Extract time series data for the current pixel (i,j) within the Night 1 time window.</span>
            <span class="k">for</span> <span class="n">time_index_temp</span> <span class="ow">in</span> <span class="n">list_night_1</span><span class="p">:</span>
                <span class="n">temp_1</span> <span class="o">=</span> <span class="n">band_values1</span><span class="p">[</span><span class="n">time_index_temp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">temp_2</span> <span class="o">=</span> <span class="n">band_values2</span><span class="p">[</span><span class="n">time_index_temp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="n">values_temp_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_1</span><span class="p">)</span>
                <span class="n">values_temp_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_2</span><span class="p">)</span>

            <span class="c1"># Perform independent t-test.</span>
            <span class="n">t_statistic</span><span class="p">,</span> <span class="n">p_value_ttest</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">values_temp_1</span><span class="p">,</span> <span class="n">values_temp_2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Store the result.</span>
            <span class="k">if</span> <span class="n">p_value_ttest</span> <span class="o">&lt;</span> <span class="n">alpha_test</span><span class="p">:</span>
                <span class="n">t_test_results_night1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t_test_results_night1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># Save results to cache for future fast loading</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span>
        <span class="n">cache_file</span><span class="p">,</span>
        <span class="n">day1</span><span class="o">=</span><span class="n">t_test_results_day1</span><span class="p">,</span>
        <span class="n">day2</span><span class="o">=</span><span class="n">t_test_results_day2</span><span class="p">,</span>
        <span class="n">night1</span><span class="o">=</span><span class="n">t_test_results_night1</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualize-t-test-results-heatmaps-day-1-and-day-2">
<h2>13. Visualize T-test Results Heatmaps (Day 1 and Day 2)<a class="headerlink" href="#visualize-t-test-results-heatmaps-day-1-and-day-2" title="Link to this heading"></a></h2>
<p>This section generates heatmaps to visualize the results of the pixel-wise independent t-tests for Day 1 and Day 2. The heatmaps clearly distinguish between areas where temperature differences are statistically significant versus areas where they are not.</p>
<ul class="simple">
<li><p>T-test Heatmaps: Displaying pixels colored based on the t-test outcome (Reject Null or Fail to Reject Null).</p></li>
<li><p>AOI Overlays: Outlining predefined Areas of Interest (AOIs) with buffers.</p></li>
<li><p>Statistical Tables: Summarizing the count and percentage of pixels within each AOI that either rejected or failed to reject the null hypothesis.</p></li>
<li><p>Aesthetic Enhancements: Custom color bars, grid lines, and geographic elements (north arrow, scale bar) for improved interpretation.</p></li>
</ul>
<p>These visualizations provide crucial insights into the spatial extent of the impact of Scenario 1 on air temperature.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare lists of t-test result arrays for plotting (Day 1 and Day 2).</span>
<span class="n">t_test_results_list_masked_day</span> <span class="o">=</span> <span class="p">[</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_test_results_day1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=~</span><span class="n">buildings_2d_data</span><span class="o">.</span><span class="n">mask</span><span class="p">),</span>
                                   <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_test_results_day2</span><span class="p">,</span> <span class="n">mask</span><span class="o">=~</span><span class="n">buildings_2d_data</span><span class="o">.</span><span class="n">mask</span><span class="p">)]</span>

<span class="c1"># Titles for the t-test result subplots.</span>
<span class="n">list_of_titles_ttest_day</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2023-06-14 +01&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-06-15 +01&#39;</span><span class="p">]</span>

<span class="c1"># --- Plotting T-test Results for Day 1 and Day 2 ---</span>
<span class="c1"># Create a figure and two subplots.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>

<span class="c1"># Set the main title for the t-test result plot.</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;T-test Ergebnis (Alpha = </span><span class="si">{</span><span class="n">alpha_test</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">variable_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">t_test_results_list_masked_day</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="c1"># Define a custom colormap for t-test results:</span>
    <span class="c1"># - &#39;#40E0D0&#39; (turquoise) for &#39;Reject null&#39; (significant difference, value 1).</span>
    <span class="c1"># - &#39;#ffffff&#39; (white) for &#39;Failed to reject null&#39; (no significant difference, value 2).</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">lsc</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s2">&quot;CustomCmap&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;#40E0D0&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">],</span> <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;#474747&#39;</span><span class="p">)</span> <span class="c1"># Grey for masked (building) areas.</span>
    
    <span class="c1"># Plot the t-test result data.</span>
    <span class="n">pcm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">variable_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># vmin/vmax ensure 1 and 2 map correctly to colors.</span>
    
    <span class="c1"># Extract raw values for statistics.</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">variable_data</span><span class="p">[:,:]</span>
    
    <span class="c1"># Define buffer distance and plot buffered AOIs.</span>
    <span class="n">buffer_distance</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">buffered_gdf</span> <span class="o">=</span> <span class="n">gdf_uhi</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">buffered_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffered_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer_distance</span><span class="p">,</span> <span class="n">join_style</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">buffered_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;//&#39;</span><span class="p">)</span> <span class="c1"># Red edges for AOIs.</span>
    
    <span class="c1"># Initialize lists to store counts of &#39;Reject null&#39; (count_1) and &#39;Failed to reject null&#39; (count_2) pixels.</span>
    <span class="n">count_1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">count_2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">count_sum</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Total count of valid pixels within each AOI.</span>

    <span class="c1"># Iterate through each AOI to compute pixel counts.</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf_uhi</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">min_x</span><span class="o">-</span><span class="n">origin_x</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">min_y</span><span class="o">-</span><span class="n">origin_y</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_x</span><span class="o">-</span><span class="n">origin_x</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_y</span><span class="o">-</span><span class="n">origin_y</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">)</span>

        <span class="c1"># Extract values within the AOI, including the buffer.</span>
        <span class="n">values_polygon</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">y1</span><span class="o">-</span><span class="n">buffer_distance</span><span class="p">:</span><span class="n">y2</span><span class="o">+</span><span class="n">buffer_distance</span><span class="p">,</span> <span class="n">x1</span><span class="o">-</span><span class="n">buffer_distance</span><span class="p">:</span><span class="n">x2</span><span class="o">+</span><span class="n">buffer_distance</span><span class="p">]</span>
        <span class="c1"># Count pixels with value 1 (Reject null) and 2 (Failed to reject null).</span>
        <span class="n">count_ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">values_polygon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">count_twos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">values_polygon</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">count_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count_ones</span><span class="p">)</span>
        <span class="n">count_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count_twos</span><span class="p">)</span>
        <span class="n">count_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count_ones</span> <span class="o">+</span> <span class="n">count_twos</span><span class="p">)</span>
        
        <span class="c1"># Annotate AOIs.</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">],</span> 
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">),</span> 
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">25</span><span class="p">),</span> 
                    <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span> 
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> 
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                    <span class="n">path_effects</span><span class="o">=</span><span class="p">[</span><span class="n">pe</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)])</span>
    
    <span class="c1"># Configure grid, labels, and ticks.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Easting&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Northing&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelrotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">center_yticks</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">y_val</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">list_of_titles_ttest_day</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">25</span><span class="p">)</span>
    
    <span class="c1"># Create color bar for t-test results.</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;4%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;T-test Ergebnis&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

    <span class="c1"># Set custom ticks and labels for the color bar.</span>
    <span class="n">custom_ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">]</span>
    <span class="n">custom_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Signifikant (N ≠ H0)&#39;</span><span class="p">,</span> <span class="s1">&#39;Nicht Signifikant (N = H0)&#39;</span><span class="p">]</span> <span class="c1"># N ≠ H0: Null hypothesis rejected</span>
                                                                         <span class="c1"># N = H0: Null hypothesis failed to be rejected</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">custom_ticks</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="n">custom_labels</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    
    <span class="c1"># Create a table summarizing t-test results by pixel count and percentage within AOIs.</span>
    <span class="n">table_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;AOI&quot;</span><span class="p">,</span> <span class="s2">&quot;Anzahl Signifikanter Pixel (N ≠ H0)&quot;</span><span class="p">,</span> <span class="s2">&quot;Anzahl Nicht Signifikanter Pixel (N = H0)&quot;</span><span class="p">],</span> 
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">count_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">count_sum</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">count_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">count_sum</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">count_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">count_sum</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">count_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">count_sum</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">count_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">count_sum</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count_2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">count_2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">count_sum</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">cellText</span><span class="o">=</span><span class="n">table_data</span><span class="p">,</span>
                     <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                     <span class="n">cellLoc</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                     <span class="n">colWidths</span><span class="o">=</span><span class="p">[</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">],</span>
                     <span class="n">edges</span><span class="o">=</span><span class="s1">&#39;open&#39;</span><span class="p">,</span>
                     <span class="n">bbox</span><span class="o">=</span><span class="p">[</span><span class="mf">0.195</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.225</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">])</span>
    <span class="n">table</span><span class="o">.</span><span class="n">auto_set_font_size</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    
    <span class="n">plot_north_arrow_and_scale_bar</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ccaec46c3a2ef9e79c35451c9e304979304d0282377dd31b3e7b557578be73f8.png" src="../_images/ccaec46c3a2ef9e79c35451c9e304979304d0282377dd31b3e7b557578be73f8.png" />
</div>
</div>
</section>
<section id="visualize-t-test-results-heatmaps-night-1">
<h2>14. Visualize T-test Results Heatmaps (Night 1)<a class="headerlink" href="#visualize-t-test-results-heatmaps-night-1" title="Link to this heading"></a></h2>
<p>This section generates heatmaps to visualize the results of the pixel-wise independent t-tests for Night 1. The heatmaps clearly distinguish between areas where temperature differences are statistically significant versus areas where they are not.</p>
<ul class="simple">
<li><p>T-test Heatmaps: Displaying pixels colored based on the t-test outcome (Reject Null or Fail to Reject Null).</p></li>
<li><p>AOI Overlays: Outlining predefined Areas of Interest (AOIs) with buffers.</p></li>
<li><p>Statistical Tables: Summarizing the count and percentage of pixels within each AOI that either rejected or failed to reject the null hypothesis.</p></li>
<li><p>Aesthetic Enhancements: Custom color bars, grid lines, and geographic elements (north arrow, scale bar) for improved interpretation.</p></li>
</ul>
<p>These visualizations provide crucial insights into the spatial extent of the impact of Scenario 1 on air temperature during the night.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare lists of t-test result arrays for plotting (Night 1).</span>
<span class="n">t_test_results_list_masked_night</span> <span class="o">=</span> <span class="p">[</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_test_results_night1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=~</span><span class="n">buildings_2d_data</span><span class="o">.</span><span class="n">mask</span><span class="p">)]</span>

<span class="c1"># Titles for the t-test result subplots.</span>
<span class="n">list_of_titles_ttest_night</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2023-06-14/15 +01&#39;</span><span class="p">]</span>

<span class="c1"># --- Plotting T-test Results for Night 1 ---</span>
<span class="c1"># Create a figure and a single subplot.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>

<span class="c1"># Set the main title for the t-test result plot.</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;T-test Ergebnis (Alpha = </span><span class="si">{</span><span class="n">alpha_test</span><span class="si">}</span><span class="s2">) (Night 1)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="c1"># Directly assign axs for a single subplot.</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span>
<span class="n">variable_data</span> <span class="o">=</span> <span class="n">t_test_results_list_masked_night</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
<span class="c1"># Define a custom colormap for t-test results.</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">lsc</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s2">&quot;CustomCmap&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;#40E0D0&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">],</span> <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;#474747&#39;</span><span class="p">)</span>

<span class="c1"># Plot the t-test result data.</span>
<span class="n">pcm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">variable_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
<span class="c1"># Extract raw values for statistics.</span>
<span class="n">values</span> <span class="o">=</span> <span class="n">variable_data</span><span class="p">[:,:]</span>
    
<span class="c1"># Define buffer distance and plot buffered AOIs.</span>
<span class="n">buffer_distance</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">buffered_gdf</span> <span class="o">=</span> <span class="n">gdf_uhi</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">buffered_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffered_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer_distance</span><span class="p">,</span> <span class="n">join_style</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">buffered_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;//&#39;</span><span class="p">)</span>

<span class="c1"># Initialize lists to store counts of &#39;Reject null&#39; (count_1) and &#39;Failed to reject null&#39; (count_2) pixels.</span>
<span class="n">count_1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">count_2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">count_sum</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Iterate through each AOI to compute pixel counts.</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf_uhi</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">polygon</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span>
    <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">bounds</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">min_x</span><span class="o">-</span><span class="n">origin_x</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">min_y</span><span class="o">-</span><span class="n">origin_y</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_x</span><span class="o">-</span><span class="n">origin_x</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_y</span><span class="o">-</span><span class="n">origin_y</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">)</span>

    <span class="n">values_polygon</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">y1</span><span class="o">-</span><span class="n">buffer_distance</span><span class="p">:</span><span class="n">y2</span><span class="o">+</span><span class="n">buffer_distance</span><span class="p">,</span> <span class="n">x1</span><span class="o">-</span><span class="n">buffer_distance</span><span class="p">:</span><span class="n">x2</span><span class="o">+</span><span class="n">buffer_distance</span><span class="p">]</span>
    <span class="n">count_ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">values_polygon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">count_twos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">values_polygon</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">count_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count_ones</span><span class="p">)</span>
    <span class="n">count_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count_twos</span><span class="p">)</span>
    <span class="n">count_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count_ones</span> <span class="o">+</span> <span class="n">count_twos</span><span class="p">)</span>
        
    <span class="c1"># Annotate AOIs.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">],</span> 
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">),</span> 
                <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">25</span><span class="p">),</span> 
                <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span> 
                <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> 
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">path_effects</span><span class="o">=</span><span class="p">[</span><span class="n">pe</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)])</span>

<span class="c1"># Configure grid, labels, and ticks.</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Easting&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Northing&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelrotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">center_yticks</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">y_val</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">list_of_titles_ttest_night</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">25</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">25</span><span class="p">)</span>

<span class="c1"># Create color bar for t-test results.</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;4%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;T-test Ergebnis&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

<span class="c1"># Set custom ticks and labels for the color bar.</span>
<span class="n">custom_ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">]</span>
<span class="n">custom_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Signifikant (N ≠ H0)&#39;</span><span class="p">,</span> <span class="s1">&#39;Nicht Signifikant (N = H0)&#39;</span><span class="p">]</span> 
<span class="n">cb</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">custom_ticks</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="n">custom_labels</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

<span class="c1"># Create a table summarizing t-test results.</span>
<span class="n">table_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s2">&quot;AOI&quot;</span><span class="p">,</span> <span class="s2">&quot;Anzahl Signifikanter Pixel (N ≠ H0)&quot;</span><span class="p">,</span> <span class="s2">&quot;Anzahl Nicht Signifikanter Pixel (N = H0)&quot;</span><span class="p">],</span> 
    <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">count_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">count_sum</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">count_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">count_sum</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">count_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">count_sum</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">count_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">count_sum</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">location_name_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">count_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">count_sum</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count_2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">count_2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">count_sum</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">],</span>
<span class="p">]</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">cellText</span><span class="o">=</span><span class="n">table_data</span><span class="p">,</span>
                 <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                 <span class="n">cellLoc</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                 <span class="n">colWidths</span><span class="o">=</span><span class="p">[</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">],</span>
                 <span class="n">edges</span><span class="o">=</span><span class="s1">&#39;open&#39;</span><span class="p">,</span>
                 <span class="n">bbox</span><span class="o">=</span><span class="p">[</span><span class="mf">0.195</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.225</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">])</span>
<span class="n">table</span><span class="o">.</span><span class="n">auto_set_font_size</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plot_north_arrow_and_scale_bar</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/fe87d63cfdb294ac56c737c99e50ce48a0d265e7cd4a5050d6318079843679f6.png" src="../_images/fe87d63cfdb294ac56c737c99e50ce48a0d265e7cd4a5050d6318079843679f6.png" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="03_Air_Temp_Analysis_BS_vs_S1.html" class="btn btn-neutral float-left" title="2D Air Temperature Analysis: Baseline vs. Scenario" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="05_Air_Temp_with_Agg.html" class="btn btn-neutral float-right" title="2D Air Temperature Aggregation Tool" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, str.ucture GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>