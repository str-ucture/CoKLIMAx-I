

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3D Variable Extraction and Aggregation &mdash; CoKLIMAx 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
      <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=822aaed9" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=8d563738"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script type="application/vnd.jupyter.widget-state+json">{"state": {"666b96d734a04a8881bec25f2fae7064": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "b08852a80bc8482f95ab52097325426e": {"model_name": "DescriptionStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "description_width": ""}}, "f3e164b127d34ebb9c6b60e4994d91e2": {"model_name": "DropdownModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "DropdownModel", "_options_labels": ["wdir", "wspeed"], "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "DropdownView", "description": "Select test variable:", "description_allow_html": false, "disabled": false, "index": 1, "layout": "IPY_MODEL_666b96d734a04a8881bec25f2fae7064", "style": "IPY_MODEL_b08852a80bc8482f95ab52097325426e", "tabbable": null, "tooltip": null}}}, "version_major": 2, "version_minor": 0}</script>
      <script crossorigin="anonymous" data-jupyter-widgets-cdn="https://cdn.jsdelivr.net/npm/" src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.6/dist/embed-amd.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Comparison of Observed vs Simulation Data" href="01_Obs_vs_Sim.html" />
    <link rel="prev" title="3D Variable Surface Extraction" href="_02_3D_to_2d_Surface_Var_Extract.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            CoKLIMAx
              <img src="../_static/coklimax_logo_new.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Data Preparation:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="_01_2D_Var_Agg_and_Extract.html">2D Variable Aggregation and Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="_02_3D_to_2d_Surface_Var_Extract.html">3D Variable Surface Extraction</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3D Variable Extraction and Aggregation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#import-dependencies">1. Import Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="#load-simulation-data">2. Load Simulation Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#variable-selection">3. Variable Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#temporal-aggregation-function">4. Temporal Aggregation Function</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prepare-data-for-aggregation">5. Prepare Data for Aggregation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#perform-aggregation-and-save-data">6. Perform Aggregation and Save Data</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Preminimary:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="01_Obs_vs_Sim.html">Comparison of Observed vs Simulation Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_Distance_of_AOI_vs_t-test.html">Distance of AOI vs t-test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Variable: Temperature:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="03_Air_Temp_Analysis_BS_vs_S1.html">2D Air Temperature Analysis: Baseline vs. Scenario</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_Air_Temp_Analysis_Heatmaps.html">2D Air Temperature Analysis: Heatmaps</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_Air_Temp_with_Agg.html">2D Air Temperature Aggregation Tool</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Variables: Biometeorology:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="06_Bio_Var_Analysis_BS_vs_S1.html">2D Biometeorological Variable Analysis: Baseline vs. Scenario</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_Bio_Var_Analysis_BS_vs_S1.html">Biological Variable Analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Variables: Wind:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="08_2D_Wspeed_with_Agg.html">2D Windspeed Visualization</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CoKLIMAx</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">3D Variable Extraction and Aggregation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/_03_2D_Surface_Var_Agg_and_Extract.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="d-variable-extraction-and-aggregation">
<h1>3D Variable Extraction and Aggregation<a class="headerlink" href="#d-variable-extraction-and-aggregation" title="Link to this heading"></a></h1>
<p>This notebook provides a robust tool for extracting specific 3D variables (such as wind speed and direction) from PALM (Potsdam Atmospheric Large-Eddy Simulation Model) NetCDF output files. It offers functionality to perform temporal aggregation (e.g., calculating hourly averages) on these variables and then saves the processed, aggregated data into new NetCDF files. This process is essential for reducing data size and preparing variables for further analysis and visualization.</p>
<section id="import-dependencies">
<h2>1. Import Dependencies<a class="headerlink" href="#import-dependencies" title="Link to this heading"></a></h2>
<p>This section imports all necessary Python libraries for numerical operations, NetCDF file handling, interactive widget creation for user input, and basic operating system interactions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">netCDF4</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">netCDF4</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ipywidgets</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">widgets</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">palm_variables</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-simulation-data">
<h2>2. Load Simulation Data<a class="headerlink" href="#load-simulation-data" title="Link to this heading"></a></h2>
<p>This section defines the file paths for the 3D simulation output NetCDF files (for baseline and scenario 1) and the static driver file. It then loads these files into netCDF4 Dataset objects, making their contents accessible for processing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Absolute URLs (paths) of 3D simulation output files</span>
<span class="n">file_xy_1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;./Data/3d_surface_output/konstanz_4096x4096_v9_Baseline_av_3d_N03.000-wdir-wspeed.nc&quot;</span>
<span class="n">file_xy_2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;./Data/3d_surface_output/konstanz_4096x4096_v9_Scenario_1_av_3d_N03.000-wdir-wspeed.nc&quot;</span>
<span class="n">file_static</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;./Data/_simulation_outputs_3/konstanz_4096x4096_v9_Scenario_1-48hr/INPUT/konstanz_4096x4096_v9_Scenario_1_static_N03&quot;</span>

<span class="c1"># Read NetCDF files into Dataset objects in read mode (&#39;r&#39;)</span>
<span class="n">dataset_1</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">file_xy_1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">dataset_2</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">file_xy_2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">dataset_3</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">file_static</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

<span class="c1"># Store datasets in a list for easier iteration</span>
<span class="n">file_xy_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_xy_1</span><span class="p">,</span> <span class="n">file_xy_2</span><span class="p">]</span>
<span class="n">dataset_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset_1</span><span class="p">,</span> <span class="n">dataset_2</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="variable-selection">
<h2>3. Variable Selection<a class="headerlink" href="#variable-selection" title="Link to this heading"></a></h2>
<p>This section allows the user to interactively select a 3D variable from the loaded NetCDF datasets. A dropdown widget is provided for selection, and the chosen variable’s description and unit (retrieved from the palm_variables module) are displayed for clear identification.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract variable names from the first dataset where the number of dimensions is greater than 2.</span>
<span class="c1"># In PALM 3D output files, these typically represent variables with (time, z, y, x) dimensions.</span>
<span class="n">var_names_palm</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">dataset_1</span><span class="o">.</span><span class="n">variables</span> <span class="k">if</span> <span class="n">dataset_1</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">]</span>

<span class="c1"># Initialize `test_variable` with the second variable in the list (`var_names_palm[1]`),</span>
<span class="c1"># as common 3D variables like &#39;wspeed&#39; are often at this index in specific output files.</span>
<span class="n">test_variable</span> <span class="o">=</span> <span class="n">var_names_palm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Create a dropdown widget to allow the user to select the desired 3D variable.</span>
<span class="n">drop_down</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
    <span class="n">options</span><span class="o">=</span><span class="n">var_names_palm</span><span class="p">,</span>         <span class="c1"># Populate the dropdown with the extracted 3D variable names.</span>
    <span class="n">value</span><span class="o">=</span><span class="n">var_names_palm</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>        <span class="c1"># Set the initial selected value in the dropdown.</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Select test variable:&#39;</span> <span class="c1"># Label displayed next to the dropdown.</span>
<span class="p">)</span>

<span class="c1"># Define a handler function that will be called whenever the dropdown&#39;s value changes.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dropdown_handler</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">test_variable</span>  <span class="c1"># Declare `test_variable` as global to modify it.</span>
    <span class="n">test_variable</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">new</span>     <span class="c1"># Update the global `test_variable` with the newly selected value.</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected variable: </span><span class="si">{</span><span class="n">test_variable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Print the newly selected variable to the console.</span>

<span class="c1"># Attach the `dropdown_handler` function to observe changes in the &#39;value&#39; property of the dropdown.</span>
<span class="n">drop_down</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">dropdown_handler</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>

<span class="c1"># Display the dropdown widget in the notebook output.</span>
<span class="n">display</span><span class="p">(</span><span class="n">drop_down</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "f3e164b127d34ebb9c6b60e4994d91e2"}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check if a `test_variable` has been selected.</span>
<span class="k">if</span> <span class="n">test_variable</span><span class="p">:</span>
    <span class="c1"># Use the `test_variable` directly to get its info, as 3D variables typically don&#39;t have &#39;*&#39; in their names</span>
    <span class="c1"># for metadata lookup (unlike some 2D variables like &#39;ta_2m*_xy&#39;).</span>
    <span class="n">var_initial</span> <span class="o">=</span> <span class="n">test_variable</span>
    
    <span class="c1"># Retrieve the dictionary of information for the `var_initial` from the `palm_variables` module.</span>
    <span class="c1"># `.get()` is used to prevent errors if the key is not found, returning an empty dict instead.</span>
    <span class="n">variable_info</span> <span class="o">=</span> <span class="n">palm_variables</span><span class="o">.</span><span class="n">variables_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var_initial</span><span class="p">,</span> <span class="p">{})</span>
    
    <span class="c1"># Extract the &#39;unit&#39; from `variable_info`, defaulting to &#39;No unit available&#39; if the key is missing.</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">variable_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;No unit available&#39;</span><span class="p">)</span>
    <span class="c1"># Extract the &#39;description&#39; from `variable_info`, defaulting to &#39;No description available&#39; if the key is missing.</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">variable_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;No description available&#39;</span><span class="p">)</span>
    
    <span class="c1"># Print the capitalized description and its unit for clarity.</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">description</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Magnitude of the horizontal wind vector, m/s
</pre></div>
</div>
</div>
</div>
</section>
<section id="temporal-aggregation-function">
<h2>4. Temporal Aggregation Function<a class="headerlink" href="#temporal-aggregation-function" title="Link to this heading"></a></h2>
<p>This section defines a crucial helper function, get_aggregate_time_list. This function is responsible for generating lists of time step indices that correspond to specific aggregation windows. This is essential for calculating moving averages over the simulation’s time series data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_aggregate_time_list</span><span class="p">(</span><span class="n">total_time_steps</span><span class="p">,</span> <span class="n">aggregate_time_steps</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a list of time step ranges for temporal aggregation (e.g., for moving averages).</span>
<span class="sd">    Each inner list represents a window of time steps.</span>

<span class="sd">    Args:</span>
<span class="sd">        total_time_steps (int): The total number of time steps available in the simulation output.</span>
<span class="sd">        aggregate_time_steps (int): The desired size of the aggregation window (number of time steps).</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of lists, where each inner list contains integer time indices</span>
<span class="sd">              that fall within a specific aggregation window.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time_lists</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_time_steps</span><span class="p">):</span>
        <span class="c1"># Case 1: No aggregation or single time step (window size is 1)</span>
        <span class="k">if</span> <span class="n">aggregate_time_steps</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">time_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># Case 2: Aggregation with a specified window size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Calculate the half-window size. This is used to define the window around the current time step `i`.</span>
            <span class="n">half_window</span> <span class="o">=</span> <span class="n">aggregate_time_steps</span> <span class="o">//</span> <span class="mi">2</span>
            
            <span class="c1"># Determine the start and end indices for the aggregation window.</span>
            <span class="c1"># The calculation slightly differs for even vs. odd `aggregate_time_steps` to ensure correct centering.</span>
            <span class="k">if</span> <span class="n">aggregate_time_steps</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># For even window sizes, the window is centered around `i` by extending `half_window` backward</span>
                <span class="c1"># and `half_window - 1` forward, then including `i`.</span>
                <span class="c1"># Example: If aggregate_time_steps=6, half_window=3. For `i=10`, range is [10-3, 10+3] = [7, 13]</span>
                <span class="c1"># The window is [7, 8, 9, 10, 11, 12] (6 steps).</span>
                <span class="n">time_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">half_window</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">half_window</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For odd window sizes, the window is perfectly centered around `i`.</span>
                <span class="c1"># Example: If aggregate_time_steps=5, half_window=2. For `i=10`, range is [10-2, 10+2+1] = [8, 13]</span>
                <span class="c1"># The window is [8, 9, 10, 11, 12] (5 steps).</span>
                <span class="n">time_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">half_window</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">half_window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        
        <span class="c1"># Filter `time_list` to ensure all indices are within the valid range of the simulation (0 to `total_time_steps - 1`).</span>
        <span class="n">valid_time_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">time_list</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">total_time_steps</span><span class="p">]</span>
        <span class="n">time_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_time_list</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">time_lists</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="prepare-data-for-aggregation">
<h2>5. Prepare Data for Aggregation<a class="headerlink" href="#prepare-data-for-aggregation" title="Link to this heading"></a></h2>
<p>This section prepares the necessary data for the aggregation process. It extracts the base filenames from the input simulation files and loads the selected 3D variable data from both dataset_1 and dataset_2. It also sets the aggregate_time_steps parameter (defaulting to 6, representing a 1-hour aggregation for 10-minute time steps) and generates the corresponding time_lists for aggregation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract the base filename (without path and extension) from the first xy output file.</span>
<span class="c1"># This will be used in naming the aggregated output files.</span>
<span class="n">filename_xy_1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_xy_1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># Extract the base filename for the second xy output file.</span>
<span class="c1"># NOTE: The original code had a typo here, using file_xy_1 for both. Corrected to file_xy_2.</span>
<span class="n">filename_xy_2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_xy_2</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Load the actual variable data for the `test_variable` from `dataset_1` and `dataset_2`.</span>
<span class="c1"># `test_variable` is determined by the dropdown selection in a previous step.</span>
<span class="n">variable_data_1</span> <span class="o">=</span> <span class="n">dataset_1</span><span class="p">[</span><span class="n">test_variable</span><span class="p">]</span>
<span class="n">variable_data_2</span> <span class="o">=</span> <span class="n">dataset_2</span><span class="p">[</span><span class="n">test_variable</span><span class="p">]</span>

<span class="c1"># Get the full shape of the 3D variable data (time, z, y, x) from `dataset_1`.</span>
<span class="c1"># The first element (`[0]`) gives the total number of time steps.</span>
<span class="n">variable_data_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dataset_1</span><span class="p">[</span><span class="n">test_variable</span><span class="p">])</span>
<span class="n">total_time_steps</span> <span class="o">=</span> <span class="n">variable_data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Define the aggregation window size.</span>
<span class="c1"># A value of 6 means that each aggregated data point will be an average over 6 consecutive time steps.</span>
<span class="c1"># (If original time steps are 10 minutes, 6 steps = 60 minutes = 1 hour).</span>
<span class="n">aggregate_time_steps</span> <span class="o">=</span> <span class="mi">6</span>

<span class="c1"># Generate the list of time step ranges for aggregation based on the `total_time_steps` and `aggregate_time_steps`.</span>
<span class="c1"># This list (`time_lists`) will guide the averaging process.</span>
<span class="n">time_lists</span> <span class="o">=</span> <span class="n">get_aggregate_time_list</span><span class="p">(</span><span class="n">total_time_steps</span><span class="p">,</span> <span class="n">aggregate_time_steps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="perform-aggregation-and-save-data">
<h2>6. Perform Aggregation and Save Data<a class="headerlink" href="#perform-aggregation-and-save-data" title="Link to this heading"></a></h2>
<p>This final section iterates through each of the loaded simulation datasets. For each dataset, it computes the temporal aggregate of the selected 3D variable using the previously defined aggregation windows (time_lists). The aggregated data (which is effectively 2D after averaging along the z-dimension) is then saved into new NetCDF files, organized in a subdirectory named after the aggregation window size.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Iterate through each dataset in the `dataset_list` (e.g., Baseline and Scenario 1 simulations).</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">current_dataset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">):</span>
    <span class="c1"># Extract the variable data for the `test_variable` from the current dataset.</span>
    <span class="n">variable_data</span> <span class="o">=</span> <span class="n">current_dataset</span><span class="p">[</span><span class="n">test_variable</span><span class="p">]</span>
    
    <span class="c1"># Get the total number of time steps for the current variable data.</span>
    <span class="n">current_total_time_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">variable_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Regenerate `time_lists` to ensure it&#39;s correct for the current dataset&#39;s total time steps,</span>
    <span class="c1"># in case datasets have different lengths or `aggregate_time_steps` was changed.</span>
    <span class="n">time_lists</span> <span class="o">=</span> <span class="n">get_aggregate_time_list</span><span class="p">(</span><span class="n">current_total_time_steps</span><span class="p">,</span> <span class="n">aggregate_time_steps</span><span class="p">)</span>
    
    <span class="c1"># Initialize a list to store the aggregated 2D arrays for all time steps.</span>
    <span class="n">variable_data_agg</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Loop through each generated time window (`time_list`) to compute the aggregate.</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">time_window_indices</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_lists</span><span class="p">):</span>
        <span class="n">values_in_window</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># For each time index within the current window, extract the 2D slice of the variable.</span>
        <span class="c1"># We are specifically selecting the first z-layer (index 0) as this notebook focuses on 2D output.</span>
        <span class="k">for</span> <span class="n">time_idx</span> <span class="ow">in</span> <span class="n">time_window_indices</span><span class="p">:</span>
            <span class="c1"># Assuming `variable_data` has dimensions (time, z, y, x).</span>
            <span class="n">values_in_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variable_data</span><span class="p">[</span><span class="n">time_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
            
        <span class="c1"># Compute the mean of all 2D slices collected in the current window along the time axis (axis=0).</span>
        <span class="c1"># This results in a single 2D array representing the aggregated value for that time window.</span>
        <span class="n">variable_data_agg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values_in_window</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        
    <span class="c1"># Determine the base filename for the output NetCDF file from the original file path.</span>
    <span class="n">source_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_xy_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Construct the `output_filename` by appending the `test_variable` name (with &#39;*&#39; removed if present).</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source_filename</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">test_variable</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="c1"># Define the output directory based on the aggregation time steps and type of variable (e.g., &#39;wind&#39;).</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./output/_03_agg_</span><span class="si">{</span><span class="n">aggregate_time_steps</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="c1"># Create the output directory if it doesn&#39;t already exist. `exist_ok=True` prevents an error if it exists.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Save the aggregated data to a new NetCDF file.</span>
    <span class="c1"># The file is opened in write mode (&quot;w&quot;) and formatted as &#39;NETCDF4_CLASSIC&#39;.</span>
    <span class="k">with</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s2">.nc&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4_CLASSIC&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_dataset</span><span class="p">:</span>
        <span class="c1"># Create dimensions in the new NetCDF file.</span>
        <span class="c1"># `num_time`: number of aggregated time steps.</span>
        <span class="c1"># `num_z_index`: fixed to 1 as we are extracting a single z-layer.</span>
        <span class="c1"># `num_y`: number of rows in the 2D array.</span>
        <span class="c1"># `num_x`: number of columns in the 2D array.</span>
        <span class="n">num_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">variable_data_agg</span><span class="p">)</span>
        <span class="n">num_z_index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">num_y</span> <span class="o">=</span> <span class="n">variable_data_agg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Number of rows (y-dimension)</span>
        <span class="n">num_x</span> <span class="o">=</span> <span class="n">variable_data_agg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Number of columns (x-dimension)</span>
        
        <span class="n">output_dataset</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">num_time</span><span class="p">)</span>
        <span class="n">output_dataset</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">num_z_index</span><span class="p">)</span>
        <span class="n">output_dataset</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">num_y</span><span class="p">)</span> <span class="c1"># Create &#39;y&#39; dimension</span>
        <span class="n">output_dataset</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">num_x</span><span class="p">)</span> <span class="c1"># Create &#39;x&#39; dimension</span>
        
        <span class="c1"># Create the variable in the new NetCDF file.</span>
        <span class="c1"># Data type is `np.float32`, dimensions are (time, z, y, x), and a fill value is defined.</span>
        <span class="n">data_var</span> <span class="o">=</span> <span class="n">output_dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">test_variable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mf">9999.0</span><span class="p">)</span>
        
        <span class="c1"># Fill the newly created variable with the aggregated 2D data.</span>
        <span class="c1"># Each aggregated 2D array is assigned to its corresponding time step and the first z-layer.</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variable_data_agg</span><span class="p">):</span>
            <span class="n">data_var</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">array</span> <span class="c1"># Assign the 2D aggregated array to the NetCDF variable</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aggregated data for &#39;</span><span class="si">{</span><span class="n">test_variable</span><span class="si">}</span><span class="s2">&#39; saved to: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s1">.nc&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Aggregated data for &#39;wspeed&#39; saved to: ./output/_03_agg_6\konstanz_4096x4096_v9_Baseline_av_3d_N03_wspeed.nc
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Aggregated data for &#39;wspeed&#39; saved to: ./output/_03_agg_6\konstanz_4096x4096_v9_Scenario_1_av_3d_N03_wspeed.nc
</pre></div>
</div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="_02_3D_to_2d_Surface_Var_Extract.html" class="btn btn-neutral float-left" title="3D Variable Surface Extraction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="01_Obs_vs_Sim.html" class="btn btn-neutral float-right" title="Comparison of Observed vs Simulation Data" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, str.ucture GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>